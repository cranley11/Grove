<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Grove" />
  <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjMDA0ZDJhIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzAwMmQxOCIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIHJ4PSI0MCIgZmlsbD0idXJsKCNiZykiLz4KICA8IS0tIFRvcG8gbGluZXMgZmFpbnQgYmFja2dyb3VuZCAtLT4KICA8cGF0aCBkPSJNMCAxMzAgQyAzMCAxMjIsIDcwIDExMCwgMTEwIDEwNSBDIDE0NSAxMDAsIDE2NSAxMDgsIDE4MCAxMTIiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjA3KSIgc3Ryb2tlLXdpZHRoPSIxLjUiLz4KICA8cGF0aCBkPSJNMCAxMDggQyAzNSA5OCwgNzUgODUsIDExOCA4MCBDIDE1MCA3NiwgMTY4IDg0LCAxODAgODgiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjA3KSIgc3Ryb2tlLXdpZHRoPSIxLjUiLz4KICA8cGF0aCBkPSJNMTAgODYgQyA0NSA3NCwgODIgNjAsIDEyNSA1NiBDIDE1NSA1MywgMTcwIDYwLCAxODAgNjUiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjA2KSIgc3Ryb2tlLXdpZHRoPSIxLjUiLz4KICA8IS0tIFRyZWU6IHRydW5rIC0tPgogIDxyZWN0IHg9Ijg0IiB5PSIxMTgiIHdpZHRoPSIxMiIgaGVpZ2h0PSIyOCIgcng9IjQiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC45KSIvPgogIDwhLS0gVHJlZTogYm90dG9tIGNhbm9weSBsYXllciAtLT4KICA8cG9seWdvbiBwb2ludHM9IjkwLDUyIDEyOCwxMDggNTIsMTA4IiBmaWxsPSJ3aGl0ZSIgb3BhY2l0eT0iMC45NSIvPgogIDwhLS0gVHJlZTogbWlkZGxlIGNhbm9weSBsYXllciAtLT4KICA8cG9seWdvbiBwb2ludHM9IjkwLDM0IDEyMiw4OCA1OCw4OCIgZmlsbD0id2hpdGUiLz4KICA8IS0tIFRyZWU6IHRvcCBjYW5vcHkgbGF5ZXIgLS0+CiAgPHBvbHlnb24gcG9pbnRzPSI5MCwxOCAxMTQsNjYgNjYsNjYiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==" />
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxODAgMTgwIj4KICA8ZGVmcz4KICAgIDxsaW5lYXJHcmFkaWVudCBpZD0iYmciIHgxPSIwJSIgeTE9IjAlIiB4Mj0iMTAwJSIgeTI9IjEwMCUiPgogICAgICA8c3RvcCBvZmZzZXQ9IjAlIiBzdG9wLWNvbG9yPSIjMDA0ZDJhIi8+CiAgICAgIDxzdG9wIG9mZnNldD0iMTAwJSIgc3RvcC1jb2xvcj0iIzAwMmQxOCIvPgogICAgPC9saW5lYXJHcmFkaWVudD4KICA8L2RlZnM+CiAgPHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIHJ4PSI0MCIgZmlsbD0idXJsKCNiZykiLz4KICA8IS0tIFRvcG8gbGluZXMgZmFpbnQgYmFja2dyb3VuZCAtLT4KICA8cGF0aCBkPSJNMCAxMzAgQyAzMCAxMjIsIDcwIDExMCwgMTEwIDEwNSBDIDE0NSAxMDAsIDE2NSAxMDgsIDE4MCAxMTIiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjA3KSIgc3Ryb2tlLXdpZHRoPSIxLjUiLz4KICA8cGF0aCBkPSJNMCAxMDggQyAzNSA5OCwgNzUgODUsIDExOCA4MCBDIDE1MCA3NiwgMTY4IDg0LCAxODAgODgiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjA3KSIgc3Ryb2tlLXdpZHRoPSIxLjUiLz4KICA8cGF0aCBkPSJNMTAgODYgQyA0NSA3NCwgODIgNjAsIDEyNSA1NiBDIDE1NSA1MywgMTcwIDYwLCAxODAgNjUiIGZpbGw9Im5vbmUiIHN0cm9rZT0icmdiYSgyNTUsMjU1LDI1NSwwLjA2KSIgc3Ryb2tlLXdpZHRoPSIxLjUiLz4KICA8IS0tIFRyZWU6IHRydW5rIC0tPgogIDxyZWN0IHg9Ijg0IiB5PSIxMTgiIHdpZHRoPSIxMiIgaGVpZ2h0PSIyOCIgcng9IjQiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC45KSIvPgogIDwhLS0gVHJlZTogYm90dG9tIGNhbm9weSBsYXllciAtLT4KICA8cG9seWdvbiBwb2ludHM9IjkwLDUyIDEyOCwxMDggNTIsMTA4IiBmaWxsPSJ3aGl0ZSIgb3BhY2l0eT0iMC45NSIvPgogIDwhLS0gVHJlZTogbWlkZGxlIGNhbm9weSBsYXllciAtLT4KICA8cG9seWdvbiBwb2ludHM9IjkwLDM0IDEyMiw4OCA1OCw4OCIgZmlsbD0id2hpdGUiLz4KICA8IS0tIFRyZWU6IHRvcCBjYW5vcHkgbGF5ZXIgLS0+CiAgPHBvbHlnb24gcG9pbnRzPSI5MCwxOCAxMTQsNjYgNjYsNjYiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPg==" />
  <meta name="theme-color" content="#F7F3EC" />
  <title>Grove</title>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;0,9..144,700;1,9..144,400&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet" />
  <style>
    :root {
      --green: #004225;
      --green-mid: #005a33;
      --green-light: #e8f2ec;
      --cream: #F0EBE0;
      --surface: #FAF7F2;
      --surface-raised: #FFFFFF;
      --ink: #0D0D0D;
      --ink-muted: #6B6B6B;
      --ink-faint: #C4C4C0;
      --surface: #FAF7F2;
      --border: #E8E4DC;
      --red: #C0392B;
      --amber: #D4780A;
      --blue: #1A4ED8;
      --purple: #6D28D9;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; background: var(--cream); color: var(--ink); font-family: 'DM Sans', sans-serif; overflow: hidden; -webkit-font-smoothing: antialiased; }
    #app { display: flex; flex-direction: column; height: 100%; height: 100dvh; }

    /* ── Onboarding ── */
    #onboarding { position: fixed; inset: 0; background: var(--cream); z-index: 500; display: flex; flex-direction: column; padding: 0; overflow: hidden; }
    .ob-header { padding: 56px 24px 0; flex-shrink: 0; }
    .ob-logo { font-family: 'Fraunces', serif; font-size: 24px; font-weight: 700; letter-spacing: -0.5px; color: var(--green); margin-bottom: 32px; }
    .ob-progress { display: flex; gap: 4px; margin-bottom: 28px; }
    .ob-dot { flex: 1; height: 3px; border-radius: 2px; background: var(--border); transition: background 0.2s; }
    .ob-dot.done { background: var(--green); }
    .ob-dot.active { background: #90A89D; }
    .ob-step { flex: 1; overflow-y: auto; padding: 0 24px 24px; }
    .ob-step-num { font-size: 10px; font-weight: 600; color: var(--ink-faint); text-transform: uppercase; letter-spacing: 0.14em; margin-bottom: 10px; }
    .ob-q { font-family: 'Fraunces', serif; font-size: 26px; line-height: 1.25; font-weight: 600; margin-bottom: 8px; color: var(--ink); }
    .ob-hint { font-size: 13px; color: var(--ink-muted); margin-bottom: 24px; font-weight: 300; line-height: 1.6; }
    .ob-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
    .ob-chip { padding: 9px 16px; border: 1.5px solid var(--border); border-radius: 100px; font-family: 'DM Sans', sans-serif; font-size: 13px; cursor: pointer; color: var(--ink-muted); background: var(--surface); transition: all 0.1s; user-select: none; }
    .ob-chip.selected { background: var(--green); color: #fff; border-color: var(--green); }
    .ob-chip:active { transform: scale(0.96); }
    .ob-text-input { width: 100%; padding: 13px 16px; border: 1.5px solid var(--border); border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 15px; outline: none; background: var(--surface); color: var(--ink); margin-bottom: 8px; }
    .ob-text-input:focus { border-color: var(--green); }
    .ob-remote-toggle { display: flex; align-items: center; gap: 10px; padding: 13px 16px; background: var(--surface); border: 1.5px solid var(--border); border-radius: 12px; cursor: pointer; margin-bottom: 16px; transition: all 0.1s; }
    .ob-remote-toggle.on { border-color: var(--green); background: var(--green-light); }
    .ob-toggle-label { font-size: 14px; color: var(--ink); flex: 1; }
    .ob-toggle-box { width: 40px; height: 22px; background: var(--border); border-radius: 11px; position: relative; transition: background 0.15s; flex-shrink: 0; }
    .ob-remote-toggle.on .ob-toggle-box { background: var(--green); }
    .ob-toggle-thumb { width: 18px; height: 18px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: left 0.15s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .ob-remote-toggle.on .ob-toggle-thumb { left: 20px; }
    .ob-footer { padding: 16px 24px; padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px)); flex-shrink: 0; border-top: 1px solid var(--border); background: var(--cream); }
    .ob-next { width: 100%; padding: 15px; background: var(--green); color: #fff; border: none; border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 15px; font-weight: 500; cursor: pointer; transition: opacity 0.1s, transform 0.1s; letter-spacing: 0.01em; }
    .ob-next:disabled { opacity: 0.25; cursor: not-allowed; }
    .ob-next:active:not(:disabled) { opacity: 0.85; transform: scale(0.99); }
    .ob-back { width: 100%; padding: 10px; background: transparent; border: none; font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--ink-faint); cursor: pointer; margin-top: 8px; }
    .ob-skip { font-size: 13px; color: var(--ink-faint); text-align: center; display: block; cursor: pointer; margin-top: 6px; }

    /* ── Prefs banner ── */
    .prefs-banner { background: var(--surface-raised); border-radius: 12px; padding: 11px 15px; margin-bottom: 14px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 0 0 1px rgba(0,0,0,0.05); }
    .prefs-tags { display: flex; gap: 5px; flex-wrap: wrap; flex: 1; }
    .prefs-tag { font-size: 11px; padding: 3px 9px; border-radius: 100px; background: var(--green); color: #fff; font-weight: 500; letter-spacing: 0.02em; }
    .prefs-edit { font-size: 12px; color: var(--ink-muted); border: none; background: transparent; cursor: pointer; font-family: 'DM Sans', sans-serif; flex-shrink: 0; padding: 4px 8px; }

    /* ── Main app ── */
    /* topbar base styles moved to Ambient Topbar section */
    .topbar-row { display: flex; align-items: center; justify-content: space-between; }
    .topbar-logo-btn { background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 0; -webkit-tap-highlight-color: transparent; }
    .topbar-logo-btn:active .topbar-logo-text { opacity: 0.7; }
    .topbar-logo-text { font-family: 'Fraunces', serif; font-size: 24px; font-weight: 700; letter-spacing: -0.5px; color: var(--green); transition: opacity 0.1s; }
    .topbar-page-label { font-family: 'Fraunces', serif; font-size: 24px; font-weight: 300; letter-spacing: -0.5px; color: var(--green); opacity: 0.45; transition: opacity 0.1s; }
    .settings-btn { background: none; border: none; cursor: pointer; padding: 6px; color: var(--ink-faint); border-radius: 8px; transition: color 0.1s, background 0.1s; margin-top: 0; flex-shrink: 0; }
    .settings-btn:hover { color: var(--green); background: var(--green-light); }

    /* ── Tab bar ── */
    .tab-bar { display: flex; background: var(--surface); border-top: 1px solid var(--border); flex-shrink: 0; padding: 0 4px; padding-bottom: env(safe-area-inset-bottom, 0px); position: fixed; bottom: 0; left: 0; right: 0; z-index: 100; box-shadow: 0 -4px 24px rgba(0,0,0,0.06); }
    .tab-btn { flex: 1; padding: 10px 4px 8px; border: none; background: transparent; font-family: 'DM Sans', sans-serif; font-size: 10px; font-weight: 500; color: var(--ink-faint); cursor: pointer; border-top: 2px solid transparent; transition: all 0.18s cubic-bezier(0.34,1.56,0.64,1); display: flex; flex-direction: column; align-items: center; gap: 3px; letter-spacing: 0.03em; text-transform: uppercase; }
    .tab-btn.active { color: var(--green); border-top-color: var(--green); }
    .tab-btn svg { transition: transform 0.18s cubic-bezier(0.34,1.56,0.64,1); }
    .tab-btn.active svg { transform: translateY(-1px); }
    .content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 0 18px 16px; padding-bottom: calc(84px + env(safe-area-inset-bottom, 0px)); }
    .content.home-content { padding: 0 16px; padding-bottom: calc(84px + env(safe-area-inset-bottom, 0px)); }

    /* ── Search ── */
    .search-row { display: flex; gap: 8px; margin-bottom: 12px; }
    .search-input { flex: 1; padding: 13px 16px; border: none; border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 14px; background: var(--surface-raised); outline: none; color: var(--ink); box-shadow: 0 0 0 1px rgba(0,0,0,0.07); transition: box-shadow 0.15s; }
    .search-input:focus { box-shadow: 0 0 0 2px rgba(0,66,37,0.35); }
    .search-btn { padding: 0 18px; background: var(--green); color: #fff; border: none; border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap; letter-spacing: 0.02em; }
    .filters { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 4px; margin-bottom: 16px; scrollbar-width: none; }
    .filters::-webkit-scrollbar { display: none; }
    .filter-pill { padding: 7px 15px; border: none; border-radius: 100px; background: var(--surface-raised); box-shadow: 0 0 0 1px rgba(0,0,0,0.06); font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--ink-muted); cursor: pointer; white-space: nowrap; transition: all 0.15s; flex-shrink: 0; font-weight: 500; }
    .filter-pill.active { background: var(--green); color: #fff; box-shadow: 0 2px 8px rgba(0,66,37,0.3); }

    /* ── Job cards ── */
    .jobs-list { display: flex; flex-direction: column; gap: 12px; }
    .job-card { background: var(--surface-raised); border-radius: 16px; padding: 18px; cursor: pointer; transition: all 0.18s cubic-bezier(0.2,0,0,1); box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 0 0 1px rgba(0,0,0,0.04); }
    .job-card:hover { box-shadow: 0 6px 24px rgba(0,66,37,0.1), 0 0 0 1px rgba(0,66,37,0.08); transform: translateY(-2px); }
    .job-card:active { transform: scale(0.97) translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,0.04); transition-duration: 0.08s; }
    .job-card-top { display: flex; align-items: flex-start; gap: 12px; }
    .job-logo { width: 44px; height: 44px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; color: #fff; flex-shrink: 0; font-family: 'Fraunces', serif; overflow: hidden; }
    .job-logo img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .job-logo-fallback { width: 42px; height: 42px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 17px; color: #fff; flex-shrink: 0; font-family: 'Fraunces', serif; }
    .job-meta { flex: 1; min-width: 0; }
    .job-title { font-size: 14px; font-weight: 600; line-height: 1.3; letter-spacing: -0.1px; color: var(--ink); }
    .job-company { font-size: 12px; color: var(--ink-muted); margin-top: 3px; font-weight: 400; }
    .job-tags { display: flex; gap: 5px; flex-wrap: wrap; margin-top: 10px; }
    .tag { font-size: 11px; padding: 3px 10px; border-radius: 100px; background: var(--cream); color: var(--ink-muted); font-weight: 500; letter-spacing: 0.01em; }
    .job-card-actions { display: flex; gap: 8px; margin-top: 12px; }
    .btn-sm { flex: 1; padding: 10px; border-radius: 10px; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 500; cursor: pointer; border: none; background: var(--cream); color: var(--ink-muted); transition: all 0.15s cubic-bezier(0.2,0,0,1); text-align: center; letter-spacing: 0.02em; }
    .btn-sm.primary { background: var(--green); color: #fff; box-shadow: 0 2px 8px rgba(0,66,37,0.25); }
    .btn-sm:active { transform: scale(0.96); opacity: 0.9; transition-duration: 0.06s; }

    /* ── States ── */
    .loader { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px; color: var(--ink-faint); gap: 12px; }
    .spinner { width: 22px; height: 22px; border: 2px solid var(--border); border-top-color: var(--green); border-radius: 50%; animation: spin 0.7s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .empty { text-align: center; padding: 48px 20px; color: var(--ink-faint); font-size: 14px; line-height: 1.7; }

    /* ── Tracker ── */
    .tracker-section-label { font-family: 'Fraunces', serif; font-size: 13px; font-weight: 600; color: var(--ink-muted); text-transform: uppercase; letter-spacing: 0.08em; margin: 18px 0 8px; display: flex; align-items: center; gap: 8px; }
    .tracker-section-label .tsl-count { font-family: 'DM Sans', sans-serif; font-size: 11px; font-weight: 600; padding: 1px 7px; border-radius: 100px; }
    .tracker-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 0 4px; }
    .tracker-header-title { font-family: 'Fraunces', serif; font-size: 20px; font-weight: 700; color: var(--ink); }
    .tracker-summary { display: flex; gap: 8px; margin-bottom: 4px; }
    .ts-chip { flex: 1; padding: 12px 10px; border-radius: 12px; text-align: center; border: 1.5px solid transparent; }
    .ts-chip-num { font-family: 'Fraunces', serif; font-size: 22px; font-weight: 700; line-height: 1; }
    .ts-chip-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.07em; margin-top: 3px; opacity: 0.75; }
    .add-btn { padding: 9px 18px; background: var(--green); color: #fff; border: none; border-radius: 100px; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 10px rgba(0,66,37,0.25); transition: all 0.15s; letter-spacing: 0.01em; }
    .add-btn:active { opacity: 0.85; }
    .app-card { background: var(--surface-raised); border-radius: 14px; padding: 15px 17px; display: flex; align-items: center; gap: 12px; margin-bottom: 8px; transition: box-shadow 0.15s; box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 0 0 1px rgba(0,0,0,0.04); }
    .app-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.08), 0 0 0 1px rgba(0,0,0,0.04); transform: translateY(-1px); transition: all 0.15s; }
    .app-status-bar { width: 3px; height: 36px; border-radius: 2px; flex-shrink: 0; }
    .app-info { flex: 1; min-width: 0; }
    .app-title { font-size: 13px; font-weight: 500; color: var(--ink); }
    .app-company { font-size: 12px; color: var(--ink-muted); }
    .app-notes { font-size: 11px; color: var(--ink-faint); margin-top: 2px; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .app-date { font-size: 10px; color: var(--ink-faint); white-space: nowrap; flex-shrink: 0; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
    .status-select { font-size: 11px; padding: 5px 9px; border: none; border-radius: 100px; background: var(--cream); font-family: 'DM Sans', sans-serif; cursor: pointer; outline: none; flex-shrink: 0; font-weight: 600; color: var(--ink-muted); box-shadow: 0 0 0 1px rgba(0,0,0,0.08); }

    /* ── Resume ── */
    .rtabs { display: flex; gap: 4px; margin-bottom: 18px; background: var(--cream); border: 1.5px solid var(--border); border-radius: 10px; padding: 3px; }
    .rtab { flex: 1; padding: 8px 12px; border-radius: 100px; border: none; background: transparent; font-family: 'DM Sans', sans-serif; font-size: 12px; cursor: pointer; color: var(--ink-muted); transition: all 0.15s; font-weight: 500; text-align: center; letter-spacing: 0.02em; }
    .rtab.active { background: var(--green); color: #fff; box-shadow: 0 2px 8px rgba(0,66,37,0.25); font-weight: 600; }
    .section-label { font-size: 10px; font-weight: 700; color: var(--ink-faint); text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 8px; }
    textarea { width: 100%; padding: 14px 16px; border: none; border-radius: 14px; font-family: 'DM Sans', sans-serif; font-size: 13px; line-height: 1.8; resize: vertical; outline: none; background: var(--surface-raised); box-shadow: 0 0 0 1.5px rgba(0,0,0,0.07); transition: box-shadow 0.15s; color: var(--ink); }
    textarea:focus { box-shadow: 0 0 0 2px rgba(0,66,37,0.3); }
    .generate-btn { margin-top: 12px; width: 100%; padding: 14px; background: var(--green); color: #fff; border: none; border-radius: 11px; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; letter-spacing: 0.02em; transition: opacity 0.1s, transform 0.1s; }
    .generate-btn:hover { opacity: 0.9; }
    .generate-btn:active { transform: scale(0.99); }
    .generate-btn:disabled { opacity: 0.35; cursor: not-allowed; }
    .cl-output { margin-top: 16px; background: var(--surface-raised); border-radius: 14px; padding: 22px; font-size: 13px; line-height: 1.9; color: var(--ink); white-space: pre-wrap; box-shadow: 0 0 0 1px rgba(0,0,0,0.05), inset 3px 0 0 var(--green); }
    .copy-btn { margin-top: 8px; width: 100%; padding: 11px; border: 1.5px solid var(--border); border-radius: 9px; background: var(--surface); font-family: 'DM Sans', sans-serif; font-size: 13px; cursor: pointer; color: var(--ink-muted); font-weight: 500; transition: all 0.1s; }
    .copy-btn:hover { border-color: var(--green); color: var(--green); }
    .quick-fill-box { background: var(--surface); border: 1.5px solid var(--border); border-radius: 12px; padding: 18px; margin-top: 4px; }
    .quick-fill-box h4 { font-family: 'Fraunces', serif; font-size: 16px; font-weight: 600; margin-bottom: 4px; color: var(--ink); }
    .quick-fill-box p { font-size: 12px; color: var(--ink-muted); margin-bottom: 16px; line-height: 1.6; }
    .fill-field { margin-bottom: 10px; }
    .fill-label { font-size: 10px; color: var(--ink-faint); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 4px; font-weight: 700; }
    .fill-value { font-size: 13px; background: var(--cream); border-radius: 8px; padding: 9px 13px; display: flex; justify-content: space-between; align-items: center; gap: 8px; border: 1px solid var(--border); }
    .fill-text { flex: 1; font-size: 13px; color: var(--ink); word-break: break-word; }
    .fill-copy { font-size: 11px; color: var(--green); border: 1px solid var(--green-light); background: var(--green-light); cursor: pointer; font-family: 'DM Sans', sans-serif; padding: 4px 10px; border-radius: 5px; flex-shrink: 0; font-weight: 600; transition: all 0.1s; }
    .fill-copy:hover { background: var(--green); color: #fff; }

    /* ── Resume Drop Zone ── */
    .resume-dropzone { border: 2px dashed var(--border); border-radius: 14px; padding: 28px 20px; text-align: center; cursor: pointer; transition: all 0.15s; background: var(--surface); margin-bottom: 14px; position: relative; }
    .resume-dropzone:hover, .resume-dropzone.drag-over { border-color: var(--green); background: var(--green-light); }
    .resume-dropzone.drag-over { transform: scale(1.01); box-shadow: 0 0 0 4px rgba(0,66,37,0.08); }
    .resume-dropzone .dz-icon { font-size: 28px; margin-bottom: 8px; }
    .resume-dropzone .dz-title { font-size: 14px; font-weight: 600; color: var(--ink); margin-bottom: 4px; }
    .resume-dropzone .dz-hint { font-size: 12px; color: var(--ink-muted); line-height: 1.5; }
    .resume-dropzone .dz-types { display: flex; gap: 5px; justify-content: center; margin-top: 10px; }
    .resume-dropzone .dz-type { font-size: 10px; padding: 2px 8px; border-radius: 6px; background: var(--cream); color: var(--ink-muted); font-weight: 600; letter-spacing: 0.04em; border: 1px solid var(--border); }
    .resume-dropzone input[type=file] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
    .parse-status { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: var(--green-light); border: 1.5px solid #B8D9C8; border-radius: 12px; margin-bottom: 12px; }
    .parse-status .ps-icon { font-size: 18px; flex-shrink: 0; }
    .parse-status .ps-text { font-size: 13px; color: var(--green); font-weight: 600; flex: 1; }
    .parse-status .ps-sub { font-size: 11px; color: #7aab8f; margin-top: 1px; }
    .parse-error { background: #FEF2F2; border-color: #FECACA; }
    .parse-error .ps-text { color: var(--red); }
    .parse-error .ps-sub { color: #EF4444; }
    .parsing-overlay { display: flex; align-items: center; gap: 10px; padding: 12px 14px; background: #FFF7ED; border: 1.5px solid #FED7AA; border-radius: 12px; margin-bottom: 12px; }
    .parsing-overlay .ps-text { font-size: 13px; color: #C2410C; font-weight: 500; }

    /* ── Modal ── */
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 200; display: flex; align-items: flex-end; backdrop-filter: blur(2px); }
    .modal-sheet { background: var(--surface-raised); border-radius: 26px 26px 0 0; padding: 26px 22px; padding-bottom: calc(26px + env(safe-area-inset-bottom, 0px)); width: 100%; max-height: 92dvh; overflow-y: auto; box-shadow: 0 -8px 40px rgba(0,0,0,0.12); }
    .modal-handle { width: 36px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 22px; }
    .modal-sheet h3 { font-family: 'Fraunces', serif; font-size: 22px; font-weight: 700; margin-bottom: 18px; color: var(--ink); letter-spacing: -0.3px; }
    .form-field { margin-bottom: 14px; }
    .form-label { font-size: 10px; font-weight: 700; color: var(--ink-faint); text-transform: uppercase; letter-spacing: 0.1em; display: block; margin-bottom: 6px; }
    .form-input, .form-select { width: 100%; padding: 13px 15px; border: none; border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 14px; outline: none; background: var(--cream); color: var(--ink); box-shadow: 0 0 0 1.5px rgba(0,0,0,0.08); transition: box-shadow 0.15s; }
    .form-input:focus { background: var(--surface-raised); box-shadow: 0 0 0 2px rgba(0,66,37,0.35); }
    .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
    .btn-cancel { flex: 1; padding: 13px; border: 1.5px solid var(--border); border-radius: 11px; background: transparent; font-family: 'DM Sans', sans-serif; font-size: 14px; cursor: pointer; color: var(--ink-muted); font-weight: 500; }
    .btn-confirm { flex: 1; padding: 13px; border: none; border-radius: 11px; background: var(--green); color: #fff; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; letter-spacing: 0.01em; }

    /* ── Job detail ── */
    .job-detail-header { display: flex; gap: 14px; margin-bottom: 14px; align-items: flex-start; }
    .job-detail-header h2 { font-family: 'Fraunces', serif; font-size: 22px; line-height: 1.25; font-weight: 700; letter-spacing: -0.3px; }
    .job-detail-co { font-size: 14px; color: var(--ink-muted); margin-top: 3px; }
    .job-detail-desc { font-size: 13px; line-height: 1.8; color: #444; margin: 12px 0 18px; }
    .detail-btn { width: 100%; padding: 14px; border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600; cursor: pointer; border: none; margin-bottom: 8px; letter-spacing: 0.01em; transition: opacity 0.1s, transform 0.1s; }
    .detail-btn:active { transform: scale(0.99); opacity: 0.9; }
    .detail-btn.primary { background: var(--green); color: #fff; }
    .detail-btn.secondary { background: var(--cream); color: var(--ink); border: 1.5px solid var(--border); }
    .detail-btn.outline { background: transparent; border: 1.5px solid var(--border); color: var(--ink-muted); }

    /* ── API Key ── */
    .api-key-banner { display: flex; align-items: center; gap: 10px; background: #FFFBEB; border: 1.5px solid #FDE68A; border-radius: 12px; padding: 11px 14px; margin-bottom: 14px; cursor: pointer; }
    .api-key-banner .akb-icon { font-size: 16px; flex-shrink: 0; }
    .api-key-banner .akb-text { font-size: 12px; color: #92400E; flex: 1; line-height: 1.4; }
    .api-key-banner .akb-link { font-size: 12px; color: var(--green); font-weight: 600; white-space: nowrap; flex-shrink: 0; }
    .api-key-set { background: var(--green-light); border-color: #B8D9C8; cursor: default; }
    .api-key-set .akb-text { color: var(--green); font-weight: 500; }
    .key-input-wrap { position: relative; }
    .key-input-wrap input { width: 100%; padding: 12px 44px 12px 14px; border: 1.5px solid var(--border); border-radius: 10px; font-family: monospace; font-size: 13px; outline: none; background: var(--cream); color: var(--ink); }
    .key-input-wrap input:focus { border-color: var(--green); background: var(--surface); }
    .key-toggle { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: var(--ink-faint); font-size: 13px; padding: 4px; font-family: 'DM Sans', sans-serif; }
    .key-hint { font-size: 11px; color: var(--ink-faint); margin-top: 6px; line-height: 1.6; }
    .key-hint a { color: var(--green); }

    /* ── Toast ── */
    .toast { position: fixed; bottom: calc(88px + env(safe-area-inset-bottom, 0px)); left: 50%; transform: translateX(-50%) translateY(6px); background: var(--ink); color: #fff; padding: 11px 22px; border-radius: 100px; font-size: 13px; font-weight: 500; z-index: 600; opacity: 0; transition: opacity 0.25s, transform 0.25s cubic-bezier(0.34,1.56,0.64,1); pointer-events: none; white-space: nowrap; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* ── Animations ── */
    .slide-in { animation: slideIn 0.22s cubic-bezier(0.22,1,0.36,1) forwards; }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .fade-up { animation: fadeUp 0.4s cubic-bezier(0.22,1,0.36,1) both; }
    .fade-up-1 { animation-delay: 0.05s; }
    .fade-up-2 { animation-delay: 0.1s; }
    .fade-up-3 { animation-delay: 0.15s; }
    .fade-up-4 { animation-delay: 0.2s; }

    /* ── Welcome Page ── */
    .welcome-wrap { padding-top: 0; }
    .welcome-hero { background: linear-gradient(135deg, #004225 0%, #005a33 60%, #006b3c 100%); border-radius: 22px; padding: 36px 26px 30px; margin-bottom: 18px; position: relative; overflow: hidden; box-shadow: 0 8px 32px rgba(0,66,37,0.2); }
    .welcome-hero::before { display: none; }
    .welcome-hero::after { display: none; }
    .welcome-eyebrow { font-size: 10px; font-weight: 700; color: rgba(255,255,255,0.5); text-transform: uppercase; letter-spacing: 0.16em; margin-bottom: 10px; }
    .welcome-logo { font-family: 'Fraunces', serif; font-size: 42px; font-weight: 700; color: #fff; letter-spacing: -1.5px; line-height: 1; margin-bottom: 12px; }
    .welcome-tagline { font-size: 13px; color: rgba(255,255,255,0.55); font-weight: 300; line-height: 1.65; max-width: 260px; margin-bottom: 24px; letter-spacing: 0.01em; }
    .welcome-headline { font-family: 'Fraunces', serif; font-size: 32px; font-weight: 700; color: #fff; letter-spacing: -1px; line-height: 1.18; margin-bottom: 10px; }
    .welcome-hero-stats { display: flex; gap: 20px; }
    .whs { }
    .whs-num { font-family: 'Fraunces', serif; font-size: 26px; font-weight: 700; color: #fff; line-height: 1; }
    .whs-label { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 2px; font-weight: 400; }
    .welcome-cards { display: flex; flex-direction: column; gap: 12px; margin-bottom: 18px; }
    .welcome-card { background: var(--surface-raised); border-radius: 18px; padding: 18px 20px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: all 0.18s cubic-bezier(0.2,0,0,1); text-align: left; width: 100%; box-shadow: 0 1px 4px rgba(0,0,0,0.05), 0 0 0 1px rgba(0,0,0,0.04); }
    .welcome-card:hover { box-shadow: 0 8px 28px rgba(0,66,37,0.1), 0 0 0 1px rgba(0,66,37,0.08); transform: translateY(-2px); }
    .welcome-card:active { transform: scale(0.97); box-shadow: 0 1px 2px rgba(0,0,0,0.04); transition-duration: 0.06s; }
    .welcome-card-icon { width: 46px; height: 46px; border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .welcome-card-body { flex: 1; min-width: 0; }
    .welcome-card-title { font-size: 15px; font-weight: 700; color: var(--ink); margin-bottom: 3px; font-family: 'Fraunces', serif; letter-spacing: -0.3px; }
    .welcome-card-desc { font-size: 12px; color: var(--ink-muted); line-height: 1.55; font-weight: 300; }
    .welcome-card-arrow { color: var(--ink-faint); font-size: 20px; flex-shrink: 0; transition: transform 0.12s, color 0.12s; font-weight: 300; }
    .welcome-card:hover .welcome-card-arrow { color: var(--green); transform: translateX(3px); }
    .welcome-tip { background: var(--cream); border-radius: 12px; padding: 14px 16px; font-size: 12px; color: var(--ink-muted); line-height: 1.65; border: 1px solid var(--border); }
    .welcome-tip strong { color: var(--green); }

    /* ── Auth Screen ── */
    #auth-screen { position: fixed; inset: 0; background: var(--cream); z-index: 900; display: flex; flex-direction: column; overflow-y: auto; }
    .auth-wrap { min-height: 100dvh; display: flex; flex-direction: column; }
    .auth-hero { background: var(--green); padding: 56px 28px 40px; position: relative; overflow: hidden; flex-shrink: 0; }
    .auth-hero::before { content: ''; position: absolute; top: -60px; right: -60px; width: 220px; height: 220px; border-radius: 50%; background: rgba(255,255,255,0.04); pointer-events: none; }
    .auth-hero::after { content: ''; position: absolute; bottom: -80px; left: -30px; width: 180px; height: 180px; border-radius: 50%; background: rgba(255,255,255,0.03); pointer-events: none; }
    .auth-logo { display: flex; align-items: center; gap: 10px; margin-bottom: 28px; }
    .auth-logo-text { font-family: 'Fraunces', serif; font-size: 28px; font-weight: 700; color: #fff; letter-spacing: -0.6px; }
    .auth-headline { font-family: 'Fraunces', serif; font-size: 32px; font-weight: 700; color: #fff; letter-spacing: -0.8px; line-height: 1.2; margin-bottom: 10px; }
    .auth-sub { font-size: 14px; color: rgba(255,255,255,0.6); font-weight: 300; line-height: 1.6; }
    .auth-demo-badge { display: inline-flex; align-items: center; gap: 5px; margin-top: 16px; padding: 5px 12px; border-radius: 20px; background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.2); font-size: 11px; color: rgba(255,255,255,0.7); font-weight: 500; letter-spacing: 0.05em; text-transform: uppercase; }
    .auth-body { padding: 32px 24px; flex: 1; }
    .auth-tabs { display: flex; background: #EDEAE3; border-radius: 12px; padding: 3px; margin-bottom: 28px; }
    .auth-tab { flex: 1; padding: 9px; border: none; background: transparent; font-family: 'Fraunces', serif; font-size: 15px; font-weight: 600; color: var(--ink-muted); cursor: pointer; border-radius: 9px; transition: all 0.15s; letter-spacing: -0.2px; }
    .auth-tab.active { background: #fff; color: var(--green); box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    .auth-field { margin-bottom: 14px; }
    .auth-label { font-size: 11px; font-weight: 600; color: var(--ink-muted); text-transform: uppercase; letter-spacing: 0.08em; display: block; margin-bottom: 6px; }
    .auth-input { width: 100%; padding: 13px 16px; border: 1.5px solid var(--border); border-radius: 12px; font-family: 'DM Sans', sans-serif; font-size: 15px; outline: none; background: #fff; color: var(--ink); transition: border 0.1s; }
    .auth-input:focus { border-color: var(--green); }
    .auth-input.error { border-color: var(--red); }
    .auth-error { font-size: 12px; color: var(--red); margin-top: 5px; display: none; }
    .auth-error.show { display: block; }
    /* Password strength */
    .pw-strength { margin-top: 8px; }
    .pw-bars { display: flex; gap: 4px; margin-bottom: 4px; }
    .pw-bar { flex: 1; height: 3px; border-radius: 2px; background: var(--border); transition: background 0.2s; }
    .pw-bar.weak { background: var(--red); }
    .pw-bar.fair { background: var(--amber); }
    .pw-bar.good { background: #2563EB; }
    .pw-bar.strong { background: #16a34a; }
    .pw-label { font-size: 11px; color: var(--ink-muted); }
    /* Requirements checklist */
    .pw-reqs { margin-top: 10px; display: flex; flex-direction: column; gap: 4px; }
    .pw-req { font-size: 12px; color: var(--ink-faint); display: flex; align-items: center; gap: 6px; transition: color 0.15s; }
    .pw-req.met { color: #16a34a; }
    .pw-req-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
    .auth-submit { width: 100%; padding: 15px; background: var(--green); color: #fff; border: none; border-radius: 13px; font-family: 'Fraunces', serif; font-size: 16px; font-weight: 700; cursor: pointer; letter-spacing: -0.2px; margin-top: 8px; transition: opacity 0.1s; }
    .auth-submit:active { opacity: 0.85; }
    .auth-submit:disabled { opacity: 0.35; cursor: not-allowed; }
    .auth-divider { text-align: center; font-size: 12px; color: var(--ink-faint); margin: 16px 0; position: relative; }
    .auth-divider::before { content: ''; position: absolute; left: 0; top: 50%; width: 40%; height: 1px; background: var(--border); }
    .auth-divider::after { content: ''; position: absolute; right: 0; top: 50%; width: 40%; height: 1px; background: var(--border); }
    .auth-footer-note { font-size: 12px; color: var(--ink-faint); text-align: center; margin-top: 20px; line-height: 1.6; padding-bottom: 32px; }
    .auth-footer-note a { color: var(--green); text-decoration: none; }
    .topbar-est { font-family: 'Fraunces', serif; font-size: 10px; font-weight: 300; color: var(--ink-faint); letter-spacing: 0.12em; text-transform: uppercase; margin-left: 2px; align-self: flex-end; padding-bottom: 3px; opacity: 0.6; }
    .topbar-right { display: flex; align-items: center; gap: 8px; }
    .topbar-auth-btns { display: flex; align-items: center; gap: 6px; }
    .topbar-btn-ghost { padding: 6px 12px; border: 1.5px solid var(--border); border-radius: 20px; background: transparent; font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 500; color: var(--ink-muted); cursor: pointer; transition: all 0.1s; white-space: nowrap; }
    .topbar-btn-ghost:active { background: var(--border); }
    .topbar-btn-solid { padding: 6px 14px; border: none; border-radius: 20px; background: var(--green); font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600; color: #fff; cursor: pointer; transition: opacity 0.1s; white-space: nowrap; }
    .topbar-btn-solid:active { opacity: 0.8; }

    .auth-browse-btn { width: 100%; padding: 12px; background: transparent; border: none; font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--ink-faint); cursor: pointer; margin-top: 4px; transition: color 0.1s; }
    .auth-browse-btn:active { color: var(--ink-muted); }
    /* User pill in topbar */
    .user-pill { display: flex; align-items: center; gap: 7px; padding: 5px 10px 5px 5px; border-radius: 20px; background: var(--green-light); border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; }
    .user-avatar { width: 26px; height: 26px; border-radius: 50%; background: var(--green); display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; font-family: 'Fraunces', serif; flex-shrink: 0; }
    .user-name { font-size: 12px; font-weight: 500; color: var(--green); max-width: 80px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ── Redesigned Home ── */
    .home-wrap { padding: 0; }
    .home-hero { background: linear-gradient(145deg, #003d20 0%, #005a33 55%, #007040 100%); margin: 0 -18px; padding: 28px 22px 32px; position: relative; overflow: hidden; }
    .home-hero-topo { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
    .home-greeting { font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.45); letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 10px; }
    .home-headline { font-family: 'Fraunces', serif; font-size: 38px; font-weight: 700; color: #fff; letter-spacing: -1.5px; line-height: 1.1; margin-bottom: 6px; }
    .home-headline em { font-style: italic; font-weight: 300; color: rgba(255,255,255,0.7); }
    .home-sub { font-size: 13px; color: rgba(255,255,255,0.5); font-weight: 300; line-height: 1.6; margin-bottom: 28px; }
    .home-stats-row { display: flex; gap: 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
    .home-stat { flex: 1; text-align: center; }
    .home-stat + .home-stat { border-left: 1px solid rgba(255,255,255,0.1); }
    .home-stat-num { font-family: 'Fraunces', serif; font-size: 28px; font-weight: 700; color: #fff; line-height: 1; letter-spacing: -1px; }
    .home-stat-label { font-size: 10px; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 0.1em; margin-top: 3px; font-weight: 500; }
    /* Action grid */
    .home-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 18px 0 6px; }
    .home-action { border-radius: 18px; padding: 20px 18px; cursor: pointer; border: none; text-align: left; position: relative; overflow: hidden; transition: transform 0.18s cubic-bezier(0.2,0,0,1), box-shadow 0.18s; }
    .home-action:active { transform: scale(0.96); transition-duration: 0.06s; }
    .home-action-full { grid-column: 1 / -1; }
    .home-action-jobs { background: #1a1a1a; }
    .home-action-track { background: #EEF2FF; }
    .home-action-resume { background: #FFF7ED; }
    .home-action-label { font-size: 9px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; margin-bottom: 10px; opacity: 0.5; }
    .home-action-title { font-family: 'Fraunces', serif; font-size: 20px; font-weight: 700; letter-spacing: -0.5px; line-height: 1.15; margin-bottom: 4px; }
    .home-action-desc { font-size: 11px; line-height: 1.5; font-weight: 300; opacity: 0.6; }
    .home-action-arrow { position: absolute; bottom: 16px; right: 18px; font-size: 18px; opacity: 0.3; transition: opacity 0.15s, transform 0.15s; }
    .home-action:hover .home-action-arrow { opacity: 0.7; transform: translateX(3px); }
    .home-action-jobs .home-action-label,
    .home-action-jobs .home-action-title,
    .home-action-jobs .home-action-desc { color: #fff; }
    .home-action-jobs .home-action-arrow { color: #fff; }
    .home-action-track .home-action-label,
    .home-action-track .home-action-title { color: #312E81; }
    .home-action-track .home-action-desc { color: #4338CA; }
    .home-action-track .home-action-arrow { color: #4338CA; }
    .home-action-resume .home-action-label,
    .home-action-resume .home-action-title { color: #92400E; }
    .home-action-resume .home-action-desc { color: #B45309; }
    .home-action-resume .home-action-arrow { color: #B45309; }
    /* Quick tip strip */
    .home-tip { margin-top: 4px; background: var(--surface-raised); border-radius: 14px; padding: 14px 16px; display: flex; gap: 12px; align-items: flex-start; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
    .home-tip-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
    .home-tip-text { font-size: 12px; color: var(--ink-muted); line-height: 1.6; font-weight: 400; }
    .home-tip-text strong { color: var(--ink); font-weight: 600; }
    /* Recent activity */
    .home-section-label { font-size: 10px; font-weight: 700; color: var(--ink-faint); text-transform: uppercase; letter-spacing: 0.12em; margin: 20px 0 10px; }
    .home-recent { display: flex; flex-direction: column; gap: 8px; }
    .home-recent-card { background: var(--surface-raised); border-radius: 14px; padding: 13px 15px; display: flex; align-items: center; gap: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 0 0 1px rgba(0,0,0,0.04); cursor: pointer; transition: all 0.15s; }
    .home-recent-card:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(0,0,0,0.08); }
    .home-recent-card:active { transform: scale(0.98); }
    .home-recent-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .home-recent-info { flex: 1; min-width: 0; }
    .home-recent-title { font-size: 13px; font-weight: 600; color: var(--ink); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .home-recent-co { font-size: 11px; color: var(--ink-muted); margin-top: 1px; }
    .home-recent-status { font-size: 10px; font-weight: 600; padding: 3px 9px; border-radius: 100px; flex-shrink: 0; }

    /* ── Redesigned Job Cards ── */
    .job-card { background: var(--surface-raised); border-radius: 18px; padding: 0; cursor: pointer; transition: all 0.18s cubic-bezier(0.2,0,0,1); box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 0 0 1px rgba(0,0,0,0.04); overflow: hidden; }
    .job-card:hover { box-shadow: 0 8px 28px rgba(0,66,37,0.1), 0 0 0 1px rgba(0,66,37,0.08); transform: translateY(-2px); }
    .job-card:active { transform: scale(0.97) translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,0.04); transition-duration: 0.06s; }
    .job-card-accent { height: 3px; width: 100%; }
    .job-card-body { padding: 16px 18px 14px; }
    .job-card-top { display: flex; align-items: flex-start; gap: 13px; margin-bottom: 12px; }
    .job-salary-badge { display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 700; color: #166534; background: #F0FDF4; padding: 3px 10px; border-radius: 100px; margin-top: 8px; }

    /* ── Dark Mode ── */
    body.dark {
      --cream: #0F1410;
      --surface: #161D18;
      --surface-raised: #1E2820;
      --ink: #F0EDE8;
      --ink-muted: #8A9E91;
      --ink-faint: #3D5244;
      --border: #2A3830;
      --green-light: #0D2018;
    }
    body.dark .home-hero { background: linear-gradient(145deg, #001a0d 0%, #002e1a 55%, #003d22 100%); }
    body.dark .home-action-jobs { background: #0a0f0c; }
    body.dark .home-action-track { background: #0f1124; }
    body.dark .home-action-resume { background: #1a0f00; }
    body.dark .ob-chip { background: var(--surface-raised); }
    body.dark .auth-screen { background: #0a0f0c; }
    body.dark .auth-form { background: var(--surface); }
    body.dark .ob-text-input { background: var(--surface-raised); color: var(--ink); border-color: var(--border); }

    /* ── Kanban Board ── */
    .kb-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 8px; margin: 0 -18px; padding-left: 18px; scrollbar-width: none; }
    .kb-wrap::-webkit-scrollbar { display: none; }
    .kb-board { display: flex; gap: 10px; width: max-content; padding-right: 18px; }
    .kb-col { width: 220px; flex-shrink: 0; border-radius: 16px; background: var(--surface); padding: 12px 10px; transition: background 0.15s, box-shadow 0.15s; min-height: 200px; }
    .kb-col.drag-over { background: var(--green-light); box-shadow: inset 0 0 0 2px var(--green); }
    .kb-col-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding: 0 4px; }
    .kb-col-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; }
    .kb-col-count { font-size: 11px; font-weight: 600; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .kb-card { background: var(--surface-raised); border-radius: 12px; padding: 12px 13px; margin-bottom: 8px; cursor: grab; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 0 0 1px rgba(0,0,0,0.04); transition: box-shadow 0.15s, transform 0.15s; user-select: none; position: relative; }
    .kb-card:active { cursor: grabbing; }
    .kb-card.dragging { opacity: 0.4; transform: rotate(2deg); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
    .kb-card:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1), 0 0 0 1px rgba(0,0,0,0.06); transform: translateY(-1px); }
    .kb-card:hover .kb-card-del { opacity: 1; }
    .kb-card-title { font-size: 13px; font-weight: 600; color: var(--ink); line-height: 1.35; margin-bottom: 3px; padding-right: 18px; }
    .kb-card-co { font-size: 11px; color: var(--ink-muted); margin-bottom: 6px; }
    .kb-card-footer { display: flex; align-items: center; justify-content: space-between; }
    .kb-card-date { font-size: 10px; color: var(--ink-faint); }
    .kb-card-move { font-size: 10px; color: var(--ink-faint); border: none; background: transparent; cursor: pointer; font-family: 'DM Sans', sans-serif; padding: 2px 6px; border-radius: 6px; transition: background 0.12s, color 0.12s; display: none; }
    .kb-card-move:hover { background: var(--green-light); color: var(--green); }
    @media (pointer: coarse) { .kb-card-move { display: inline-block; } }
    .kb-card-accent { height: 3px; border-radius: 2px; margin-bottom: 8px; }
    .kb-card-del { position: absolute; top: 7px; right: 7px; width: 20px; height: 20px; border-radius: 50%; border: none; background: transparent; color: var(--ink-faint); font-size: 13px; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.15s, background 0.15s, color 0.15s; padding: 0; line-height: 1; }
    .kb-card-del:hover { background: #fee2e2; color: #ef4444; }
    @media (pointer: coarse) { .kb-card-del { opacity: 0.5; } }
    .kb-empty { font-size: 12px; color: var(--ink-faint); text-align: center; padding: 24px 8px; font-style: italic; line-height: 1.6; }
    .kb-add { width: 100%; margin-top: 4px; padding: 8px; border: 1.5px dashed var(--border); border-radius: 10px; background: transparent; font-family: 'DM Sans', sans-serif; font-size: 12px; color: var(--ink-faint); cursor: pointer; transition: all 0.15s; }
    .kb-add:hover { border-color: var(--green); color: var(--green); background: var(--green-light); }
    /* List delete button */
    .app-del-btn { border: none; background: transparent; color: var(--ink-faint); font-size: 15px; cursor: pointer; padding: 5px 7px; border-radius: 6px; opacity: 0; transition: opacity 0.15s, color 0.15s, background 0.15s; flex-shrink: 0; line-height: 1; }
    .app-card:hover .app-del-btn { opacity: 1; }
    .app-del-btn:hover { color: #ef4444; background: #fee2e2; }
    @media (pointer: coarse) { .app-del-btn { opacity: 0.5; } }
    /* Move status sheet */
    .move-sheet-opts { display: flex; flex-direction: column; gap: 6px; margin-top: 4px; }
    .move-sheet-opt { display: flex; align-items: center; gap: 12px; padding: 13px 16px; border-radius: 12px; border: 1.5px solid var(--border); background: var(--surface); font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; cursor: pointer; text-align: left; width: 100%; transition: all 0.12s; color: var(--ink); }
    .move-sheet-opt:active { transform: scale(0.98); }
    .move-sheet-opt.current { border-color: var(--green); background: var(--green-light); color: var(--green); }
    .move-sheet-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .move-sheet-del { width: 100%; margin-top: 8px; padding: 13px; border-radius: 12px; border: 1.5px solid #fee2e2; background: #fff5f5; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: #ef4444; cursor: pointer; transition: all 0.12s; }
    .move-sheet-del:active { transform: scale(0.98); }

    /* ── Tracker header ── */
    .tracker-top { display: flex; align-items: center; justify-content: space-between; padding: 16px 0 14px; }
    .tracker-top-title { font-family: 'Fraunces', serif; font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
    .tracker-top-right { display: flex; align-items: center; gap: 8px; }
    .tracker-view-toggle { display: flex; background: var(--surface); border-radius: 8px; padding: 2px; }
    .tvt-btn { padding: 5px 10px; border-radius: 6px; border: none; background: transparent; cursor: pointer; font-size: 13px; transition: all 0.12s; color: var(--ink-faint); }
    .tvt-btn.active { background: var(--surface-raised); color: var(--green); box-shadow: 0 1px 3px rgba(0,0,0,0.08); }

    /* ── Match Score ── */
    .match-score-box { background: var(--surface-raised); border-radius: 16px; padding: 18px; margin-top: 14px; box-shadow: 0 0 0 1px rgba(0,0,0,0.05); }
    .match-score-box h4 { font-family: 'Fraunces', serif; font-size: 16px; font-weight: 700; margin-bottom: 4px; letter-spacing: -0.3px; }
    .match-score-box p { font-size: 12px; color: var(--ink-muted); margin-bottom: 14px; line-height: 1.55; }
    .match-score-ring { display: flex; align-items: center; gap: 16px; margin-bottom: 14px; }
    .score-circle { position: relative; width: 72px; height: 72px; flex-shrink: 0; }
    .score-circle svg { transform: rotate(-90deg); }
    .score-num { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-family: 'Fraunces', serif; font-size: 20px; font-weight: 700; }
    .score-label { font-size: 11px; color: var(--ink-muted); margin-top: 2px; }
    .score-meta { flex: 1; }
    .score-verdict { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .score-detail { font-size: 12px; color: var(--ink-muted); line-height: 1.6; }
    .score-gaps { margin-top: 10px; }
    .score-gap-label { font-size: 10px; font-weight: 700; color: var(--ink-faint); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 6px; }
    .score-gap-item { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--ink-muted); margin-bottom: 5px; }
    .score-gap-dot { width: 6px; height: 6px; border-radius: 50%; background: #F59E0B; flex-shrink: 0; }
    .score-gap-dot.green { background: #22C55E; }

    /* ── Empty States ── */
    .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 52px 24px; text-align: center; }
    .empty-state-art { margin-bottom: 20px; }
    .empty-state-title { font-family: 'Fraunces', serif; font-size: 20px; font-weight: 700; letter-spacing: -0.4px; color: var(--ink); margin-bottom: 8px; }
    .empty-state-sub { font-size: 13px; color: var(--ink-muted); line-height: 1.65; max-width: 240px; font-weight: 300; }
    .empty-state-btn { margin-top: 20px; padding: 11px 24px; background: var(--green); color: #fff; border: none; border-radius: 100px; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 10px rgba(0,66,37,0.25); }

    /* ── Confetti ── */
    .confetti-piece { position: fixed; width: 8px; height: 8px; border-radius: 2px; pointer-events: none; z-index: 9999; animation: confettiFall linear forwards; }
    @keyframes confettiFall {
      0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* ── Dark Mode Toggle ── */
    .dark-toggle { width: 36px; height: 20px; background: var(--border); border-radius: 10px; position: relative; cursor: pointer; border: none; transition: background 0.2s; flex-shrink: 0; }
    .dark-toggle.on { background: var(--green); }
    .dark-toggle-thumb { width: 16px; height: 16px; background: #fff; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: left 0.15s cubic-bezier(0.34,1.56,0.64,1); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .dark-toggle.on .dark-toggle-thumb { left: 18px; }

    /* ── Ambient Topbar ── */
    .topbar {
      padding: 52px 20px 14px;
      background: var(--cream);
      flex-shrink: 0;
      border-bottom: none;
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }
    .topbar.home-tab { padding-bottom: 0; }

    /* Animated SVG noise canvas behind topbar */
    .topbar-ambient {
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      overflow: hidden;
    }

    /* Slow drifting orbs */
    .tb-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(32px);
      opacity: 0;
      animation: orbDrift linear infinite;
    }
    .tb-orb-1 {
      width: 180px; height: 180px;
      background: radial-gradient(circle, rgba(0,66,37,0.18) 0%, transparent 70%);
      top: -60px; left: -40px;
      animation-duration: 18s;
      animation-delay: 0s;
      opacity: 1;
    }
    .tb-orb-2 {
      width: 140px; height: 140px;
      background: radial-gradient(circle, rgba(0,90,51,0.12) 0%, transparent 70%);
      top: -20px; right: 20px;
      animation-duration: 24s;
      animation-delay: -8s;
      opacity: 1;
    }
    .tb-orb-3 {
      width: 100px; height: 100px;
      background: radial-gradient(circle, rgba(180,200,160,0.15) 0%, transparent 70%);
      bottom: -10px; left: 40%;
      animation-duration: 30s;
      animation-delay: -14s;
      opacity: 1;
    }
    @keyframes orbDrift {
      0%   { transform: translate(0px, 0px) scale(1); }
      25%  { transform: translate(12px, -8px) scale(1.05); }
      50%  { transform: translate(-6px, 10px) scale(0.96); }
      75%  { transform: translate(8px, 4px) scale(1.03); }
      100% { transform: translate(0px, 0px) scale(1); }
    }

    /* Grain overlay — SVG feTurbulence noise */
    .tb-grain {
      position: absolute;
      inset: -50%;
      width: 200%;
      height: 200%;
      opacity: 0.035;
      animation: grainShift 0.8s steps(1) infinite;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      background-size: 200px 200px;
    }
    @keyframes grainShift {
      0%  { transform: translate(0,0); }
      10% { transform: translate(-2%,-3%); }
      20% { transform: translate(3%, 1%); }
      30% { transform: translate(-1%, 4%); }
      40% { transform: translate(4%,-1%); }
      50% { transform: translate(-3%, 2%); }
      60% { transform: translate(1%,-4%); }
      70% { transform: translate(-4%, 3%); }
      80% { transform: translate(2%, -2%); }
      90% { transform: translate(-2%, 1%); }
      100%{ transform: translate(0,0); }
    }

    /* Hairline shimmer sweep */
    .tb-shimmer {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent 0%, rgba(0,66,37,0.15) 30%, rgba(0,66,37,0.25) 50%, rgba(0,66,37,0.15) 70%, transparent 100%);
      background-size: 200% 100%;
      animation: shimmerMove 6s ease-in-out infinite;
    }
    @keyframes shimmerMove {
      0%   { background-position: -100% 0; opacity: 0.4; }
      50%  { background-position: 100% 0; opacity: 1; }
      100% { background-position: 300% 0; opacity: 0.4; }
    }

    /* Keep topbar children above the ambient layer */
    .topbar-row { position: relative; z-index: 1; }

    body.dark .tb-orb-1 { background: radial-gradient(circle, rgba(0,120,60,0.2) 0%, transparent 70%); }
    body.dark .tb-orb-2 { background: radial-gradient(circle, rgba(0,80,40,0.15) 0%, transparent 70%); }
    body.dark .tb-orb-3 { background: radial-gradient(circle, rgba(40,80,55,0.15) 0%, transparent 70%); }
    body.dark .tb-grain  { opacity: 0.025; }

  </style>
</head>
<body>
<div id="app">
  <div class="topbar" id="main-topbar">
    <div class="topbar-ambient" aria-hidden="true">
      <div class="tb-orb tb-orb-1"></div>
      <div class="tb-orb tb-orb-2"></div>
      <div class="tb-orb tb-orb-3"></div>
      <div class="tb-grain"></div>
      <div class="tb-shimmer"></div>
    </div>
    <div class="topbar-row">
      <button class="topbar-logo-btn" onclick="switchTab('home')" title="Home">
        <svg width="20" height="22" viewBox="0 0 20 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0"><polygon points="10,1 18,10 14,10 17,17 12,17 12,23 8,23 8,17 3,17 6,10 2,10" fill="#004225"/></svg>
        <span class="topbar-logo-text">Grove</span>
        <span class="topbar-page-label" id="topbar-page-label"></span>
      </button>
      <div class="topbar-right" id="topbar-right">
        <!-- Populated by updateTopbarAuth() -->
      </div>
    </div>
  </div>
  <div class="content" id="content"></div>
</div>
<div class="tab-bar" style="flex-direction:column;gap:0">
  <div style="display:flex;width:100%">
  <button class="tab-btn active" onclick="switchTab('home')" id="tab-home">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9,22 9,12 15,12 15,22"/></svg>
    Home
  </button>
  <button class="tab-btn" onclick="switchTab('search')" id="tab-search">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
    Discover
  </button>
  <button class="tab-btn" onclick="switchTab('tracker')" id="tab-tracker">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6M9 12h6M9 15h4"/></svg>
    Applications
  </button>
  <button class="tab-btn" onclick="switchTab('resume')" id="tab-resume">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>
    Resume
  </button>
  </div>
  <div style="text-align:center;padding:2px 0 4px;font-family:'Fraunces',serif;font-size:9px;font-weight:300;color:var(--ink-faint);letter-spacing:0.14em;text-transform:uppercase;opacity:0.5">est. 2026</div>
</div>

<!-- Onboarding overlay -->
<div id="onboarding">
  <div class="ob-header">
    <div class="ob-logo" style="display:flex;align-items:center;gap:8px"><svg width="20" height="22" viewBox="0 0 20 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink:0"><polygon points="10,1 18,10 14,10 17,17 12,17 12,23 8,23 8,17 3,17 6,10 2,10" fill="#004225"/></svg><span>Grove</span></div>
    <div class="ob-progress" id="ob-progress"></div>
  </div>
  <div class="ob-step" id="ob-step"></div>
  <div class="ob-footer">
    <button class="ob-next" id="ob-next" onclick="obNext()">Continue</button>
    <button class="ob-back" id="ob-back" onclick="obBack()" style="display:none">← Back</button>
    <span class="ob-skip" onclick="obSkip()">Skip setup</span>
  </div>
</div>

<!-- Auth Screen -->
<div id="auth-screen" style="display:none">
  <div class="auth-wrap">
    <div class="auth-hero">
      <div class="auth-logo">
        <svg width="22" height="24" viewBox="0 0 20 24" fill="none"><polygon points="10,1 18,10 14,10 17,17 12,17 12,23 8,23 8,17 3,17 6,10 2,10" fill="#fff"/></svg>
        <span class="auth-logo-text">Grove</span>
      </div>
      <div class="auth-headline">Your career,<br>finally organised.</div>
      <div class="auth-sub">Search smarter, track everything,<br>and land the job.</div>
      <div class="auth-demo-badge">⚡ Demo mode — data stays on your device</div>
    </div>
    <div class="auth-body">
      <div class="auth-tabs">
        <button class="auth-tab active" id="auth-tab-in" onclick="authSwitchTab('in')">Sign In</button>
        <button class="auth-tab" id="auth-tab-up" onclick="authSwitchTab('up')">Create Account</button>
      </div>

      <!-- Sign In -->
      <div id="auth-signin">
        <div class="auth-field">
          <label class="auth-label">Email</label>
          <input class="auth-input" id="si-email" type="email" placeholder="you@example.com" autocomplete="email" />
          <div class="auth-error" id="si-email-err"></div>
        </div>
        <div class="auth-field">
          <label class="auth-label">Password</label>
          <input class="auth-input" id="si-pw" type="password" placeholder="••••••••" autocomplete="current-password" />
          <div class="auth-error" id="si-pw-err"></div>
        </div>
        <div class="auth-error" id="si-general-err" style="margin-bottom:8px;font-size:13px"></div>
        <button class="auth-submit" onclick="doSignIn()">Sign In →</button>
        <div class="auth-footer-note">
          Don't have an account? <a onclick="authSwitchTab('up')" style="cursor:pointer">Create one free</a>
        </div>
        <button class="auth-browse-btn" onclick="browseAsGuest()">Browse without signing in</button>
      </div>

      <!-- Sign Up -->
      <div id="auth-signup" style="display:none">
        <div class="auth-field">
          <label class="auth-label">Your Name</label>
          <input class="auth-input" id="su-name" type="text" placeholder="Jane Doe" autocomplete="name" />
          <div class="auth-error" id="su-name-err"></div>
        </div>
        <div class="auth-field">
          <label class="auth-label">Email</label>
          <input class="auth-input" id="su-email" type="email" placeholder="you@example.com" autocomplete="email" />
          <div class="auth-error" id="su-email-err"></div>
        </div>
        <div class="auth-field">
          <label class="auth-label">Password</label>
          <input class="auth-input" id="su-pw" type="password" placeholder="••••••••" autocomplete="new-password" />

          <div class="auth-error" id="su-pw-err"></div>
        </div>
        <div class="auth-field">
          <label class="auth-label">Confirm Password</label>
          <input class="auth-input" id="su-pw2" type="password" placeholder="••••••••" autocomplete="new-password" />
          <div class="auth-error" id="su-pw2-err"></div>
        </div>
        <div class="auth-error" id="su-general-err" style="margin-bottom:8px;font-size:13px"></div>
        <button class="auth-submit" onclick="doSignUp()">Create Account →</button>
        <div class="auth-footer-note">
          Already have an account? <a onclick="authSwitchTab('in')" style="cursor:pointer">Sign in</a>
        </div>
        <button class="auth-browse-btn" onclick="browseAsGuest()">Browse without signing in</button>
      </div>

    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="modal-bg" id="modal-bg" style="display:none" onclick="closeModal()">
  <div id="modal-inner" onclick="event.stopPropagation()"></div>
</div>

<script>
// ─────────────────────────────────────────
// STATE

// ── Welcome greeting ──
function setWelcomeGreeting() {
  const hour = new Date().getHours();
  const greetings = hour < 12
    ? ['Good morning', 'Morning', 'Rise and shine']
    : hour < 17
    ? ['Good afternoon', 'Welcome back', 'Hey there']
    : ['Good evening', 'Welcome back', 'Evening'];
  const headlines = [
    'Your dream role\nis out there.',
    'Every great career\nstarts somewhere.',
    'The right job\nis looking for you.',
    'New day,\nnew possibilities.',
    'You\'ve got this.\nLet\'s find it.',
  ];
  const g = document.getElementById('welcome-greeting');
  const h = document.getElementById('welcome-headline');
  const firstName = currentUser ? ', ' + currentUser.name.split(' ')[0] : '';
  if (g) g.textContent = greetings[Math.floor(Math.random() * greetings.length)] + firstName + ' 👋';
  if (h) h.innerHTML = headlines[Math.floor(Math.random() * headlines.length)].replace('\n','<br>');
}
// ─────────────────────────────────────────
let currentTab = 'home';
let jobs = [];
let jobsLoading = false;
let jobsQuery = '';
let jobsCategory = 'All';
let applications = [];
let resumeText = '';
let coverLetter = '';
let generating = false;
let resumeSubTab = 'resume';
let coverContext = '';

// Preferences
let prefs = {
  fields: [],       // job fields/categories
  levels: [],       // experience levels
  payRanges: [],    // e.g. ["$80k–$100k", "$100k–$130k"]
  remote: false,    // fully remote only
  location: '',     // city/region if not remote
  companySize: [],  // company size preferences
};

let resumeParseStatus = null; // null | 'parsing' | 'done' | 'error'
let resumeParseMsg = '';
let resumeFileName = '';

// ── API Key ──
let apiKey = '';
try { apiKey = localStorage.getItem('jw_api_key') || ''; } catch(e) {}
function saveApiKey() { try { localStorage.setItem('jw_api_key', apiKey); } catch(e) {} }
function getApiKey() { return apiKey; }


try { applications = JSON.parse(localStorage.getItem('jw_apps') || '[]'); } catch(e) { applications = []; }
try { resumeText = localStorage.getItem('jw_resume') || defaultResume(); } catch(e) { resumeText = defaultResume(); }
try { const p = localStorage.getItem('jw_prefs'); if (p) prefs = {...prefs, ...JSON.parse(p)}; } catch(e) {}

const onboardingDone = localStorage.getItem('jw_ob_done') === '1';

function savePrefs() { try { localStorage.setItem('jw_prefs', JSON.stringify(prefs)); } catch(e) {} }
function saveApps()  { try { localStorage.setItem('jw_apps', JSON.stringify(applications)); } catch(e) {} }
function saveResume(){ try { localStorage.setItem('jw_resume', resumeText); } catch(e) {} }

function defaultResume() {
  return `Jane Doe
jane@email.com • (555) 123-4567 • linkedin.com/in/janedoe

EXPERIENCE
Product Designer — Acme Corp (2021–Present)
• Led redesign of core product increasing retention by 24%
• Managed design system used by 15 engineers

Junior Designer — Studio XYZ (2019–2021)
• Delivered 20+ client projects across web and mobile

EDUCATION
B.F.A. Graphic Design — State University, 2019

SKILLS
Figma, Sketch, Prototyping, User Research, HTML/CSS`;
}

const STATUS_COLORS = {
  Applied:      { bg:'#EEF2FF', text:'#4F46E5' },
  Interviewing: { bg:'#FFF7ED', text:'#C2410C' },
  Offer:        { bg:'#F0FDF4', text:'#166534' },
  Rejected:     { bg:'#FEF2F2', text:'#991B1B' },
  Saved:        { bg:'#F5F3FF', text:'#5B21B6' },
};
const LOGO_COLORS = ['#0F172A','#1D4ED8','#B45309','#0E7490','#7C3AED','#0F766E','#BE185D','#15803D'];
function logoColor(n) { let h=0; for(let c of (n||'?')) h=(h*31+c.charCodeAt(0))%LOGO_COLORS.length; return LOGO_COLORS[Math.abs(h)]; }
function logoLetter(n) { return (n||'?')[0].toUpperCase(); }
function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg; el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2200);
}

// ─────────────────────────────────────────
// ONBOARDING
// ─────────────────────────────────────────
const OB_STEPS = [
  {
    id: 'field',
    q: 'What type of work are you looking for?',
    hint: 'Pick one or more that fit you best.',
    type: 'multi',
    options: ['Engineering','Design','Product','Marketing','Data & Analytics','Sales','Finance','Operations','HR & People','Legal'],
    key: 'fields',
  },
  {
    id: 'level',
    q: 'What\'s your experience level?',
    hint: 'Select all that apply.',
    type: 'multi',
    options: ['Internship','Entry Level','Mid Level','Senior','Manager','Director','Executive'],
    key: 'levels',
  },
  {
    id: 'pay',
    q: 'What\'s your target pay range?',
    hint: 'Select all ranges you\'d consider.',
    type: 'multi',
    options: ['Under $60k','$60k–$80k','$80k–$100k','$100k–$130k','$130k–$160k','$160k–$200k','$200k+','No preference'],
    key: 'payRanges',
  },
  {
    id: 'location',
    q: 'Where do you want to work?',
    hint: 'Enter your city or region, and tick the box if you\'re also open to remote roles.',
    type: 'location',
    key: 'location',
  },
  {
    id: 'size',
    q: 'What size company suits you?',
    hint: 'Select all that interest you.',
    type: 'multi',
    options: ['Startup (1–50)','Small (51–200)','Mid-size (201–1k)','Large (1k–10k)','Enterprise (10k+)','No preference'],
    key: 'companySize',
  },
];

let obStep = 0;

function renderOnboarding() {
  const step = OB_STEPS[obStep];
  const total = OB_STEPS.length;

  // Progress dots
  const dots = OB_STEPS.map((_,i) => {
    const cls = i < obStep ? 'done' : i === obStep ? 'active' : '';
    return `<div class="ob-dot ${cls}"></div>`;
  }).join('');
  document.getElementById('ob-progress').innerHTML = dots;

  // Back button
  document.getElementById('ob-back').style.display = obStep > 0 ? 'block' : 'none';

  // Step content
  let content = `
    <div class="ob-step-num">Step ${obStep + 1} of ${total}</div>
    <div class="ob-q">${step.q}</div>
    <div class="ob-hint">${step.hint}</div>
  `;

  if (step.type === 'multi') {
    const selected = prefs[step.key] || [];
    content += `<div class="ob-chips">` +
      step.options.map(o =>
        `<div class="ob-chip${selected.includes(o) ? ' selected' : ''}" onclick="obToggleMulti('${step.key}','${o}')">${o}</div>`
      ).join('') +
      `</div>`;
  } else if (step.type === 'single') {
    const selected = prefs[step.key] || '';
    content += `<div class="ob-chips">` +
      step.options.map(o =>
        `<div class="ob-chip${selected === o ? ' selected' : ''}" onclick="obSelectSingle('${step.key}','${o}')">${o}</div>`
      ).join('') +
      `</div>`;
  } else if (step.type === 'location') {
    content += `
      <div style="margin-bottom:14px;position:relative">
        <label style="font-size:11px;font-weight:500;color:#aaa;text-transform:uppercase;letter-spacing:0.07em;display:block;margin-bottom:6px">Your city or region</label>
        <input class="ob-text-input" id="ob-location" placeholder="e.g. New York, Austin, London…" value="${esc(prefs.location)}" autocomplete="off" oninput="locationTyped(this.value)" />
        <div id="loc-suggestions" style="background:#fff;border:1.5px solid #E5E5E3;border-top:none;border-radius:0 0 12px 12px;overflow:hidden;display:none;position:absolute;left:0;right:0;z-index:50;box-shadow:0 4px 12px rgba(0,0,0,0.08)"></div>
        <p style="font-size:12px;color:#bbb;margin-top:5px">Leave blank to search everywhere.</p>
      </div>
      <div class="ob-remote-toggle${prefs.remote ? ' on' : ''}" onclick="obToggleRemote()" id="remote-toggle">
        <span class="ob-toggle-label">Also open to fully remote roles</span>
        <div class="ob-toggle-box"><div class="ob-toggle-thumb"></div></div>
      </div>
    `;
  }

  const stepEl = document.getElementById('ob-step');
  stepEl.innerHTML = content;
  stepEl.classList.remove('slide-in');
  void stepEl.offsetWidth;
  stepEl.classList.add('slide-in');

  // Next button state
  updateObNextBtn();
}

function updateObNextBtn() {
  const step = OB_STEPS[obStep];
  const btn = document.getElementById('ob-next');
  const isLast = obStep === OB_STEPS.length - 1;
  btn.textContent = isLast ? 'Find my jobs →' : 'Continue';

  // Enable if something selected or optional step
  let enabled = true;
  if (step.type === 'multi') enabled = (prefs[step.key]||[]).length > 0;
  else if (step.type === 'single') enabled = !!prefs[step.key];
  else if (step.type === 'location') enabled = true; // always optional
  btn.disabled = !enabled;
}

function obToggleMulti(key, val) {
  if (!prefs[key]) prefs[key] = [];
  const idx = prefs[key].indexOf(val);
  if (idx === -1) prefs[key].push(val); else prefs[key].splice(idx, 1);
  renderOnboarding();
}

function obSelectSingle(key, val) {
  prefs[key] = val;
  renderOnboarding();
}

function obToggleRemote() {
  prefs.remote = !prefs.remote;
  const toggle = document.getElementById('remote-toggle');
  if (toggle) toggle.className = 'ob-remote-toggle' + (prefs.remote ? ' on' : '');
}

function obNext() {
  // Save location input if on that step
  if (OB_STEPS[obStep].type === 'location') {
    const inp = document.getElementById('ob-location');
    if (inp) prefs.location = inp.value.trim();
  }
  savePrefs();
  if (obStep < OB_STEPS.length - 1) {
    obStep++;
    renderOnboarding();
  } else {
    finishOnboarding();
  }
}

function obBack() {
  if (obStep > 0) { obStep--; renderOnboarding(); }
}

function obSkip() {
  savePrefs();
  finishOnboarding();
}

function finishOnboarding() {
  localStorage.setItem('jw_ob_done', '1');
  const ob = document.getElementById('onboarding');
  ob.style.transition = 'opacity 0.35s, transform 0.35s';
  ob.style.opacity = '0';
  ob.style.transform = 'translateY(20px)';
  setTimeout(() => {
    ob.style.display = 'none';
    switchTab('search');
    autoSearchFromPrefs();
  }, 350);
}

async function autoSearchFromPrefs() {
  const category = prefs.fields.length ? prefs.fields[0] : '';
  const query = '';
  jobsQuery = query;
  jobsCategory = category || 'All';
  jobs = await fetchJobs(query, category, 1);
  render();
}

// ─────────────────────────────────────────
// MAIN APP
// ─────────────────────────────────────────
const TAB_LABELS = { home: '', search: 'Jobs', tracker: 'Track', resume: 'Resume' };

function switchTab(tab) {
  currentTab = tab;
  ['home','search','tracker','resume'].forEach(t => {
    const btn = document.getElementById('tab-' + t);
    if (btn) btn.classList.toggle('active', t === tab);
  });
  const topbar = document.getElementById('main-topbar');
  if (topbar) topbar.classList.toggle('home-tab', tab === 'home');
  const lbl = document.getElementById('topbar-page-label');
  if (lbl) lbl.textContent = TAB_LABELS[tab] || '';
  render();
  // Auto-load jobs the first time we open the search tab
  if (tab === 'search' && jobs.length === 0 && !jobsLoading) {
    fetchJobs('', 'All').then(result => { jobs = result; updateJobsArea(); });
    jobsLoading = true; updateJobsArea();
  }
}


// ── Company logo helpers (Clearbit) ──
function companyDomain(name) {
  const known = {
    // Big Tech
    'google': 'google.com', 'alphabet': 'google.com', 'meta': 'meta.com', 'facebook': 'meta.com',
    'apple': 'apple.com', 'microsoft': 'microsoft.com', 'amazon': 'amazon.com', 'netflix': 'netflix.com',
    'nvidia': 'nvidia.com', 'intel': 'intel.com', 'amd': 'amd.com', 'qualcomm': 'qualcomm.com',
    'ibm': 'ibm.com', 'oracle': 'oracle.com', 'sap': 'sap.com', 'dell': 'dell.com',
    'hp': 'hp.com', 'hpe': 'hpe.com', 'cisco': 'cisco.com', 'vmware': 'vmware.com',
    // Cloud & Infrastructure
    'aws': 'aws.amazon.com', 'amazonwebservices': 'aws.amazon.com',
    'azure': 'microsoft.com', 'googlecloud': 'cloud.google.com',
    'digitalocean': 'digitalocean.com', 'cloudflare': 'cloudflare.com',
    'fastly': 'fastly.com', 'akamai': 'akamai.com', 'rackspace': 'rackspace.com',
    'heroku': 'heroku.com', 'netlify': 'netlify.com', 'vercel': 'vercel.com',
    // SaaS / Productivity
    'stripe': 'stripe.com', 'shopify': 'shopify.com', 'airbnb': 'airbnb.com', 'uber': 'uber.com',
    'lyft': 'lyft.com', 'twitter': 'x.com', 'x': 'x.com', 'linkedin': 'linkedin.com',
    'salesforce': 'salesforce.com', 'hubspot': 'hubspot.com', 'notion': 'notion.so',
    'figma': 'figma.com', 'slack': 'slack.com', 'zoom': 'zoom.us', 'dropbox': 'dropbox.com',
    'square': 'squareup.com', 'block': 'block.xyz', 'twilio': 'twilio.com',
    'datadog': 'datadoghq.com', 'snowflake': 'snowflake.com', 'palantir': 'palantir.com',
    'coinbase': 'coinbase.com', 'robinhood': 'robinhood.com', 'duolingo': 'duolingo.com',
    'canva': 'canva.com', 'atlassian': 'atlassian.com', 'zendesk': 'zendesk.com',
    'workday': 'workday.com', 'servicenow': 'servicenow.com', 'okta': 'okta.com',
    'splunk': 'splunk.com', 'elastic': 'elastic.co', 'mongodb': 'mongodb.com',
    'twitch': 'twitch.tv', 'discord': 'discord.com', 'reddit': 'reddit.com',
    'pinterest': 'pinterest.com', 'snapchat': 'snap.com', 'snap': 'snap.com',
    'tiktok': 'tiktok.com', 'bytedance': 'bytedance.com', 'spotify': 'spotify.com',
    'adobe': 'adobe.com', 'autodesk': 'autodesk.com', 'intuit': 'intuit.com',
    'turbotax': 'turbotax.intuit.com', 'quickbooks': 'quickbooks.intuit.com',
    'asana': 'asana.com', 'monday': 'monday.com', 'clickup': 'clickup.com',
    'airtable': 'airtable.com', 'miro': 'miro.com', 'linear': 'linear.app',
    'jira': 'atlassian.com', 'confluence': 'atlassian.com', 'github': 'github.com',
    'gitlab': 'gitlab.com', 'bitbucket': 'bitbucket.org', 'npm': 'npmjs.com',
    'postman': 'postman.com', 'pagerduty': 'pagerduty.com', 'opsgenie': 'atlassian.com',
    'newrelic': 'newrelic.com', 'sentry': 'sentry.io', 'segment': 'segment.com',
    'mixpanel': 'mixpanel.com', 'amplitude': 'amplitude.com', 'heap': 'heap.io',
    'hotjar': 'hotjar.com', 'intercom': 'intercom.com', 'drift': 'drift.com',
    'zenefits': 'zenefits.com', 'gusto': 'gusto.com', 'rippling': 'rippling.com',
    'bamboohr': 'bamboohr.com', 'adp': 'adp.com', 'paychex': 'paychex.com',
    'greenhouse': 'greenhouse.io', 'lever': 'lever.co', 'workable': 'workable.com',
    // Fintech
    'paypal': 'paypal.com', 'venmo': 'venmo.com', 'cashapp': 'cash.app',
    'braintree': 'braintreepayments.com', 'plaid': 'plaid.com', 'affirm': 'affirm.com',
    'klarna': 'klarna.com', 'afterpay': 'afterpay.com', 'chime': 'chime.com',
    'sofi': 'sofi.com', 'wealthfront': 'wealthfront.com', 'betterment': 'betterment.com',
    'acorns': 'acorns.com', 'webull': 'webull.com', 'etrade': 'etrade.com',
    'fidelity': 'fidelity.com', 'schwab': 'schwab.com', 'vanguard': 'vanguard.com',
    'jpmorgan': 'jpmorgan.com', 'jpmorganchase': 'jpmorganchase.com', 'chase': 'chase.com',
    'bankofamerica': 'bankofamerica.com', 'wellsfargo': 'wellsfargo.com',
    'goldmansachs': 'goldmansachs.com', 'morganstanley': 'morganstanley.com',
    'blackrock': 'blackrock.com', 'citadel': 'citadel.com', 'twosigma': 'twosigma.com',
    'deshaw': 'deshaw.com', 'janestreet': 'janestreet.com', 'hudsonrivertrading': 'hudsonrivertrading.com',
    // E-commerce & Retail
    'ebay': 'ebay.com', 'etsy': 'etsy.com', 'walmart': 'walmart.com', 'target': 'target.com',
    'costco': 'costco.com', 'bestbuy': 'bestbuy.com', 'wayfair': 'wayfair.com',
    'chewy': 'chewy.com', 'instacart': 'instacart.com', 'doordash': 'doordash.com',
    'grubhub': 'grubhub.com', 'ubereats': 'ubereats.com', 'postmates': 'postmates.com',
    // Healthcare & Biotech
    'unitedhealth': 'unitedhealthgroup.com', 'unitedhealthgroup': 'unitedhealthgroup.com',
    'cvs': 'cvshealth.com', 'cvshealth': 'cvshealth.com', 'walgreens': 'walgreens.com',
    'humana': 'humana.com', 'cigna': 'cigna.com', 'anthem': 'anthem.com',
    'pfizer': 'pfizer.com', 'johnson': 'jnj.com', 'johnsonjohnson': 'jnj.com',
    'abbvie': 'abbvie.com', 'merck': 'merck.com', 'lilly': 'lilly.com',
    'modernatx': 'modernatx.com', 'moderna': 'modernatx.com', 'biontech': 'biontech.com',
    'epic': 'epic.com', 'epicsystems': 'epic.com', 'cerner': 'cerner.com',
    'veeva': 'veeva.com', 'flatiron': 'flatiron.com', 'tempus': 'tempus.com',
    // Media & Entertainment
    'disney': 'thewaltdisneycompany.com', 'waltdisney': 'thewaltdisneycompany.com',
    'comcast': 'comcast.com', 'nbc': 'nbc.com', 'nbcuniversal': 'nbcuniversal.com',
    'warnermedia': 'warnermediagroup.com', 'hbo': 'hbo.com',
    'paramount': 'paramount.com', 'sony': 'sony.com', 'sonypictures': 'sonypictures.com',
    'foxcorporation': 'foxcorporation.com', 'fox': 'fox.com',
    'viacomcbs': 'viacomcbs.com', 'peacock': 'peacocktv.com',
    // Consulting & Professional Services
    'mckinsey': 'mckinsey.com', 'mckinseycompany': 'mckinsey.com',
    'bcg': 'bcg.com', 'bostonConsultinggroup': 'bcg.com',
    'bain': 'bain.com', 'baincompany': 'bain.com',
    'deloitte': 'deloitte.com', 'pwc': 'pwc.com', 'kpmg': 'kpmg.com',
    'ey': 'ey.com', 'ernstandyoung': 'ey.com', 'accenture': 'accenture.com',
    'booz': 'boozallen.com', 'boozallen': 'boozallen.com',
    'leidos': 'leidos.com', 'saic': 'saic.com', 'mitre': 'mitre.org',
    // Automotive & Mobility
    'tesla': 'tesla.com', 'ford': 'ford.com', 'gm': 'gm.com', 'generalmotors': 'gm.com',
    'bmw': 'bmw.com', 'volkswagen': 'vw.com', 'toyota': 'toyota.com',
    'rivian': 'rivian.com', 'lucidmotors': 'lucidmotors.com', 'lucid': 'lucidmotors.com',
    'waymo': 'waymo.com', 'cruise': 'getcruise.com', 'zoox': 'zoox.com',
    // AI & ML
    'openai': 'openai.com', 'anthropic': 'anthropic.com', 'deepmind': 'deepmind.com',
    'mistral': 'mistral.ai', 'cohere': 'cohere.com', 'ai21': 'ai21.com',
    'huggingface': 'huggingface.co', 'scale': 'scale.com', 'scaleai': 'scale.com',
    'databricks': 'databricks.com', 'weights': 'wandb.ai', 'wandb': 'wandb.ai',
    // Aerospace & Defense
    'spacex': 'spacex.com', 'boeing': 'boeing.com', 'lockheedmartin': 'lockheedmartin.com',
    'northropgrumman': 'northropgrumman.com', 'raytheon': 'rtx.com', 'rtx': 'rtx.com',
    'generaldynamics': 'gd.com', 'l3harris': 'l3harris.com', 'bae': 'baesystems.com',
    // Other notable
    'doordash': 'doordash.com', 'lyft': 'lyft.com', 'wework': 'wework.com',
    'opendoor': 'opendoor.com', 'redfin': 'redfin.com', 'zillow': 'zillow.com',
    'expedia': 'expedia.com', 'booking': 'booking.com', 'airbnb': 'airbnb.com',
    'tripadvisor': 'tripadvisor.com', 'yelp': 'yelp.com', 'grubhub': 'grubhub.com',
    'roblox': 'roblox.com', 'epicgames': 'epicgames.com', 'unity': 'unity.com',
    'ea': 'ea.com', 'electronicarts': 'ea.com', 'activision': 'activision.com',
    'blizzard': 'blizzard.com', 'ubisoft': 'ubisoft.com', 'valve': 'valvesoftware.com',
  };

  // Normalize: lowercase, strip common legal suffixes and punctuation
  const normalized = name.toLowerCase()
    .replace(/\b(inc|llc|corp|ltd|co|company|group|technologies|technology|tech|solutions|services|systems|software|global|international|holdings|ventures|partners|labs|studio|studios)\b/g, '')
    .replace(/[^a-z0-9]/g, '');

  if (known[normalized]) return known[normalized];

  // Try the raw key without suffix stripping too
  const rawKey = name.toLowerCase().replace(/[^a-z0-9]/g, '');
  if (known[rawKey]) return known[rawKey];

  // Try first word only (e.g. "Acme Corp" → "acme")
  const firstWord = name.toLowerCase().split(/[\s,.()/]+/)[0].replace(/[^a-z0-9]/g, '');
  if (known[firstWord] && firstWord.length > 2) return known[firstWord];

  // Fallback: normalized slug + .com (strip legal suffixes for cleaner domain)
  return normalized.replace(/(inc|llc|corp|ltd|co)$/g, '') + '.com' || rawKey + '.com';
}

function logoHtml(company, size, directLogoUrl) {
  const szLg = size || 44;
  const imgSrc = directLogoUrl || `https://logo.clearbit.com/${companyDomain(company)}`;
  const fallbackColor = logoColor(company);
  const fallbackLetter = logoLetter(company);
  const fontSize = Math.round(szLg * 0.42);
  return `<div class="job-logo" style="width:${szLg}px;height:${szLg}px;flex-shrink:0;border-radius:10px;overflow:hidden;display:flex;align-items:center;justify-content:center;">
    <img src="${esc(imgSrc)}" alt="${esc(company)}"
      style="width:${szLg}px;height:${szLg}px;object-fit:cover;display:block;"
      onerror="this.parentNode.style.background='${fallbackColor}';this.outerHTML='<span style=\\"font-size:${fontSize}px;font-weight:700;color:#fff;font-family:Fraunces,serif;\\">${fallbackLetter}</span>'"
    />
  </div>`;
}
// ─────────────────────────────────────────
// REMOTIVE API  (free, no key, CORS-open)
// ─────────────────────────────────────────
const CATEGORIES = ['All','Engineering','Design','Marketing','Data & Analytics','Product','Sales','Finance','Operations'];

// Map Grove display categories → Remotive category slugs
const REMOTIVE_CAT_MAP = {
  'Engineering':       'software-dev',
  'Design':            'design',
  'Marketing':         'marketing',
  'Data & Analytics':  'data',
  'Product':           'product',
  'Sales':             'sales',
  'Finance':           'finance',
  'Operations':        'all-others',
};

async function fetchJobsRaw(query, category) {
  try {
    let url = 'https://remotive.com/api/remote-jobs?limit=50';
    const slug = REMOTIVE_CAT_MAP[category];
    if (slug && slug !== 'all-others') url += `&category=${encodeURIComponent(slug)}`;
    if (query) url += `&search=${encodeURIComponent(query)}`;
    const res = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    return (data.jobs || []).map(j => ({
      id: j.id,
      title: j.title || 'Untitled',
      company: j.company_name || 'Unknown',
      companyLogo: j.company_logo || null,
      location: j.candidate_required_location || 'Remote / Worldwide',
      level: '',
      category: j.category || '',
      salary: j.salary || '',
      jobType: j.job_type || '',
      url: j.url || '#',
      description: stripHtml(j.description || '').slice(0, 600),
      isRemote: true,
    }));
  } catch(e) {
    console.error('Fetch error:', e);
    return null;
  }
}

async function fetchJobs(query, category) {
  jobsLoading = true;
  try {
    const result = await fetchJobsRaw(query || '', category || 'All');
    if (result === null) { toast('Could not load jobs — check your connection'); return []; }
    return applyClientFilters(result);
  } finally {
    jobsLoading = false;
  }
}

function applyClientFilters(list) {
  let out = list;

  // Level filter: only drop if job HAS level data AND none of selected levels match
  if (prefs.levels.length > 0) {
    out = out.filter(j => {
      if (!j.level) return true; // no level info — keep it
      const jl = j.level.toLowerCase();
      return prefs.levels.some(l => {
        const key = l.toLowerCase().replace(' level','').trim();
        return jl.includes(key);
      });
    });
  }

  // Location filter: keep if matches user location OR (remote pref AND job is remote)
  if (prefs.location || prefs.remote) {
    out = out.filter(j => {
      const jloc = j.location.toLowerCase();
      const matchesCity = prefs.location && jloc.includes(prefs.location.toLowerCase().split(',')[0].trim());
      const matchesRemote = prefs.remote && j.isRemote;
      if (prefs.location && prefs.remote) return matchesCity || matchesRemote;
      if (prefs.location) return matchesCity || j.isRemote; // always include remote even if location set
      if (prefs.remote) return matchesRemote;
      return true;
    });
  }

  return out;
}

function stripHtml(html) {
  const d = document.createElement('div');
  d.innerHTML = html;
  return (d.textContent || '').trim().slice(0, 600);
}

function buildPrefsLabel() {
  const parts = [];
  if (prefs.fields.length) parts.push(...prefs.fields.slice(0,2));
  if (prefs.levels.length) parts.push(...prefs.levels.slice(0,2));
  if (prefs.payRanges && prefs.payRanges.length && !prefs.payRanges.includes('No preference')) parts.push(...prefs.payRanges.slice(0,2));
  if (prefs.location) parts.push(prefs.location);
  if (prefs.remote) parts.push('+ Remote');
  if (prefs.companySize.length && !prefs.companySize.includes('No preference')) parts.push(prefs.companySize[0]);
  return parts;
}


// ── BLS Salary data (cached) ──
const BLS_SALARIES = {
  // SOC-based median annual wages (BLS 2023, Occupational Employment Survey)
  'engineer': 104000, 'software engineer': 130160, 'developer': 130160,
  'data scientist': 108020, 'data analyst': 82000, 'data engineer': 112000,
  'designer': 79000, 'ux designer': 98000, 'product designer': 98000, 'graphic designer': 58000,
  'product manager': 122000, 'product': 122000,
  'marketing': 72000, 'marketing manager': 140000, 'content': 62000,
  'sales': 68000, 'account executive': 92000, 'sales manager': 127000,
  'finance': 95000, 'financial analyst': 95000, 'accountant': 79000,
  'operations': 76000, 'operations manager': 100000,
  'hr': 64000, 'recruiter': 67000,
  'legal': 85000, 'lawyer': 135000,
  'manager': 110000, 'director': 155000, 'vp': 185000, 'executive': 200000,
};

function blsSalaryForTitle(title) {
  if (!title) return null;
  const t = title.toLowerCase();
  // Try progressively shorter matches
  for (const [key, val] of Object.entries(BLS_SALARIES)) {
    if (t.includes(key)) return val;
  }
  return null;
}

function formatSalary(n) {
  if (!n) return null;
  return '$' + (n >= 1000 ? Math.round(n/1000) + 'k' : n);
}
// ─────────────────────────────────────────
// RENDER
// ─────────────────────────────────────────
function render() {
  const el = document.getElementById('content');
  if (!el) return;
  // Toggle topbar appearance for home tab
  const topbar = document.getElementById('main-topbar');
  if (topbar) topbar.classList.toggle('home-tab', currentTab === 'home');
  if (currentTab === 'home') { el.innerHTML = renderHome(); setWelcomeGreeting(); }
  else if (currentTab === 'search') el.innerHTML = renderSearch();
  else if (currentTab === 'tracker') el.innerHTML = renderTracker();
  else el.innerHTML = renderResume();
  attachLiveEvents();
}

// ─────────────────────────────────────────
// HOME TAB
// ─────────────────────────────────────────
function renderHome() {
  const appCount = applications.length;
  const interviewCount = applications.filter(a => a.status === 'Interviewing').length;
  const offerCount = applications.filter(a => a.status === 'Offer').length;
  const appliedCount = applications.filter(a => a.status === 'Applied').length;
  const hasKey = !!apiKey;
  const recent = applications.slice(0, 3);

  const statusColors = {
    Applied:      { bg:'#EEF2FF', text:'#4F46E5', dot:'#4F46E5' },
    Interviewing: { bg:'#FFF7ED', text:'#C2410C', dot:'#F97316' },
    Offer:        { bg:'#F0FDF4', text:'#166534', dot:'#22C55E' },
    Rejected:     { bg:'#FEF2F2', text:'#991B1B', dot:'#EF4444' },
    Saved:        { bg:'#F5F3FF', text:'#5B21B6', dot:'#8B5CF6' },
  };

  const statsHtml = appCount > 0
    ? '<div class="home-stats-row">'
      + '<div class="home-stat"><div class="home-stat-num">' + appCount + '</div><div class="home-stat-label">Tracked</div></div>'
      + '<div class="home-stat"><div class="home-stat-num">' + appliedCount + '</div><div class="home-stat-label">Applied</div></div>'
      + '<div class="home-stat"><div class="home-stat-num">' + interviewCount + '</div><div class="home-stat-label">Interviews</div></div>'
      + '<div class="home-stat"><div class="home-stat-num">' + offerCount + '</div><div class="home-stat-label">Offers</div></div>'
      + '</div>'
    : '';

  const recentHtml = recent.length > 0
    ? '<div class="home-section-label">Recent Applications</div><div class="home-recent">'
      + recent.map(function(a) {
          const sc = statusColors[a.status] || statusColors.Saved;
          return '<div class="home-recent-card" onclick="switchTab(\'tracker\')">'
            + '<div class="home-recent-dot" style="background:' + sc.dot + '"></div>'
            + '<div class="home-recent-info">'
            + '<div class="home-recent-title">' + esc(a.title) + '</div>'
            + '<div class="home-recent-co">' + esc(a.company) + '</div>'
            + '</div>'
            + '<span class="home-recent-status" style="background:' + sc.bg + ';color:' + sc.text + '">' + esc(a.status) + '</span>'
            + '</div>';
        }).join('')
      + '</div>'
    : '';

  const tipIcon = hasKey ? '💡' : '⚙️';
  const tipText = hasKey
    ? '<strong>Pro tip:</strong> Find a role → tap Apply → get a tailored cover letter in seconds.'
    : '<strong>Add your API key</strong> via settings to unlock AI cover letters.';

  const trackDesc = appCount > 0 ? appCount + ' tracked' : 'Stay organised';

  return '<div class="home-wrap">'
    + '<div class="home-hero">'
    + '<svg class="home-hero-topo" viewBox="0 0 400 220" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" preserveAspectRatio="xMidYMid slice">'
    + '<path d="M-20 180 C 20 175,60 165,110 150 C 160 135,200 120,250 115 C 300 110,350 118,400 125 L 420 220 L -20 220 Z" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>'
    + '<path d="M-20 155 C 30 148,75 135,125 118 C 175 101,215 88,265 84 C 315 80,365 90,420 100" fill="none" stroke="rgba(255,255,255,0.07)" stroke-width="1"/>'
    + '<path d="M-20 128 C 35 120,80 105,135 86 C 185 70,228 55,278 52 C 325 49,372 62,420 74" fill="none" stroke="rgba(255,255,255,0.07)" stroke-width="1"/>'
    + '<path d="M10 100 C 60 88,105 72,158 52 C 205 35,248 22,295 20 C 338 18,380 32,420 46" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="1"/>'
    + '<path d="M50 70 C 95 55,140 38,188 22 C 230 8,268 -2,308 -4 C 348 -6,385 8,420 20" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/>'
    + '</svg>'
    + '<div class="home-greeting" id="welcome-greeting"></div>'
    + '<div class="home-headline" id="welcome-headline"></div>'
    + '<div class="home-sub">Your next opportunity is closer than you think.</div>'
    + statsHtml
    + '</div>'
    + '<div class="home-actions">'
    + '<button class="home-action home-action-jobs home-action-full" onclick="goToJobs()">'
    + '<div class="home-action-label">Discover</div>'
    + '<div class="home-action-title">Find your<br>next role</div>'
    + '<div class="home-action-desc">Thousands of jobs, filtered to you</div>'
    + '<span class="home-action-arrow">\u2192</span>'
    + '</button>'
    + '<button class="home-action home-action-track" onclick="switchTab(\'tracker\')">'
    + '<div class="home-action-label">Pipeline</div>'
    + '<div class="home-action-title">Track<br>apps</div>'
    + '<div class="home-action-desc">' + trackDesc + '</div>'
    + '<span class="home-action-arrow">\u2192</span>'
    + '</button>'
    + '<button class="home-action home-action-resume" onclick="switchTab(\'resume\')">'
    + '<div class="home-action-label">AI Tools</div>'
    + '<div class="home-action-title">Resume<br>& letters</div>'
    + '<div class="home-action-desc">Apply smarter, faster</div>'
    + '<span class="home-action-arrow">\u2192</span>'
    + '</button>'
    + '</div>'
    + recentHtml
    + '<div class="home-tip">'
    + '<div class="home-tip-icon">' + tipIcon + '</div>'
    + '<div class="home-tip-text">' + tipText + '</div>'
    + '</div>'
    + '</div>';
}


// ─────────────────────────────────────────
// SEARCH TAB
// ─────────────────────────────────────────
function jobsAreaHtml() {
  if (jobsLoading) return `<div class="loader"><div class="spinner"></div><span>Finding jobs…</span></div>`;
  if (jobs.length === 0) return `<div class="empty">No jobs found.<br><br>Try a different search term or category.</div>`;
  return `<div class="jobs-list">` + jobs.map(j => {
    const accentColor = logoColor(j.company);
    const salaryDisplay = j.salary || (blsSalaryForTitle(j.title) ? `≈ ${formatSalary(blsSalaryForTitle(j.title))}/yr` : null);
    return `
    <div class="job-card">
      <div class="job-card-accent" style="background:${accentColor}"></div>
      <div class="job-card-body">
        <div class="job-card-top">
          ${logoHtml(j.company, null, j.companyLogo)}
          <div class="job-meta" style="flex:1;min-width:0">
            <div class="job-title">${esc(j.title)}</div>
            <div class="job-company">${esc(j.company)}</div>
            ${salaryDisplay ? `<div class="job-salary-badge">${esc(salaryDisplay)}</div>` : ''}
          </div>
        </div>
        <div class="job-tags" style="margin-bottom:12px">
          ${j.location?`<span class="tag">${esc(j.location.split(',')[0])}</span>`:''}
          ${j.jobType?`<span class="tag">${esc(j.jobType.replace('_',' '))}</span>`:''}
          ${j.category?`<span class="tag">${esc(j.category.split(',')[0])}</span>`:''}
        </div>
        <div class="job-card-actions">
          <button class="btn-sm primary" onclick="openJobDetail('${j.id}')">View &amp; Apply</button>
          <button class="btn-sm" onclick="trackJob('${j.id}')">+ Track</button>
        </div>
      </div>
    </div>`;
  }).join('') + `</div>`;
}

function updateJobsArea() {
  const el = document.getElementById('jobs-area');
  if (!el) { render(); return; }
  // Update filter pills in place
  document.querySelectorAll('.filter-pill').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.cat === jobsCategory);
  });
  el.style.opacity = '0';
  el.innerHTML = jobsAreaHtml();
  requestAnimationFrame(() => {
    el.style.transition = 'opacity 0.12s ease';
    el.style.opacity = '1';
  });
}

function apiKeyBanner() {
  if (apiKey) return `<div class="api-key-banner api-key-set"><span class="akb-icon">✓</span><span class="akb-text">API key saved — AI features active</span><button style="font-size:11px;color:#888;background:none;border:none;cursor:pointer;font-family:'DM Sans',sans-serif" onclick="showApiKeyModal()">Change</button></div>`;
  return `<div class="api-key-banner" onclick="showApiKeyModal()"><span class="akb-icon">🔑</span><div class="akb-text"><strong>Add your Anthropic API key</strong> to enable cover letter generation and resume parsing.</div><span class="akb-link">Set key →</span></div>`;
}

function renderSearch() {
  const prefsTags = buildPrefsLabel();
  const prefsBanner = prefsTags.length ? `
    <div class="prefs-banner">
      <div class="prefs-tags">${prefsTags.map(t=>`<span class="prefs-tag">${esc(t)}</span>`).join('')}</div>
      <button class="prefs-edit" onclick="reopenOnboarding()">Edit ✎</button>
    </div>` : '';

  const cats = CATEGORIES.map(c =>
    `<button class="filter-pill${jobsCategory===c?' active':''}" data-cat="${c}" onclick="setCategory('${c}')">${c}</button>`
  ).join('');

  return `
    ${apiKeyBanner()}
    ${prefsBanner}
    <div class="search-row">
      <input class="search-input" id="search-input" placeholder="Search roles or companies…" value="${esc(jobsQuery)}" />
      <button class="search-btn" onclick="doSearch()">Search</button>
    </div>
    <div class="filters">${cats}</div>
    <div id="jobs-area">${jobsAreaHtml()}</div>`;
}

async function doSearch() {
  const inp = document.getElementById('search-input');
  jobsQuery = inp ? inp.value.trim() : jobsQuery;
  jobsLoading = true; updateJobsArea();
  jobs = await fetchJobs(jobsQuery, jobsCategory);
  updateJobsArea();
}

async function setCategory(cat) {
  jobsCategory = cat;
  jobsLoading = true; updateJobsArea();
  jobs = await fetchJobs(jobsQuery, jobsCategory);
  updateJobsArea();
}

function reopenOnboarding() {
  obStep = 0;
  const ob = document.getElementById('onboarding');
  ob.style.display = 'flex';
  ob.style.opacity = '1';
  ob.style.transform = 'none';
  renderOnboarding();
}

function openJobDetail(id) {
  const j = jobs.find(x => String(x.id) === String(id));
  if (!j) return;
  showModal(`
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div class="job-detail-header">
        ${logoHtml(j.company, 48, j.companyLogo)}
        <div><h2>${esc(j.title)}</h2><div class="job-detail-co">${esc(j.company)}</div></div>
      </div>
      <div class="job-tags" style="margin-bottom:4px">
        ${j.location?`<span class="tag">${esc(j.location)}</span>`:''}
        ${j.level?`<span class="tag">${esc(j.level)}</span>`:''}
        ${j.category?`<span class="tag">${esc(j.category)}</span>`:''}
        ${(()=>{ const s = blsSalaryForTitle(j.title); return s ? `<span class="tag" style="background:#F0FDF4;color:#166534">≈ ${formatSalary(s)}/yr market rate</span>` : ''; })()}
      </div>
      ${j.description?`<p class="job-detail-desc">${esc(j.description)}…</p>`:''}
      <button class="detail-btn primary" onclick="openApplyFlow('${j.id}')">✦ Apply with Resume Helper</button>
      <button class="detail-btn secondary" onclick="window.open('${esc(j.url)}','_blank')">View on Remotive ↗</button>
      <button class="detail-btn outline" onclick="trackJob('${j.id}')">+ Save to Tracker</button>
    </div>`);
}

function trackJob(id) {
  const j = jobs.find(x => String(x.id) === String(id));
  if (!j) return;
  if (applications.find(a => a.sourceId === String(j.id))) { toast('Already in your tracker!'); return; }
  applications.unshift({ id: Date.now(), sourceId: String(j.id), title: j.title, company: j.company, date: todayLabel(), status: 'Saved', notes: '', url: j.url });
  saveApps();
  closeModal();
  toast('Saved to tracker ✓');
}

function openApplyFlow(id) {
  const j = jobs.find(x => String(x.id) === String(id));
  if (!j) return;
  const existing = applications.find(a => a.sourceId === String(j.id));
  if (existing) {
    // Already applied — show confirmation modal
    const dateLabel = existing.date || 'a previous session';
    showModal(`
      <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div style="text-align:center;padding:8px 0 20px">
          <div style="font-size:36px;margin-bottom:12px">🌿</div>
          <h3 style="margin-bottom:8px">Looks like you already applied</h3>
          <p style="font-size:14px;color:var(--ink-muted);line-height:1.6;margin-bottom:4px">
            You tracked <strong>${esc(j.title)}</strong> at <strong>${esc(j.company)}</strong> as
            <span style="display:inline-block;padding:2px 8px;border-radius:20px;background:#EEF2FF;color:#4F46E5;font-size:12px;font-weight:600">${esc(existing.status)}</span>
          </p>
          <p style="font-size:13px;color:var(--ink-faint);margin-bottom:24px">Applied: ${esc(dateLabel)}</p>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="detail-btn primary" onclick="doApplyAgain('${j.id}')">Apply Again — Reset Tracker</button>
            <button class="detail-btn secondary" onclick="closeModal()">Got it, I'm done here</button>
          </div>
        </div>
      </div>`);
    return;
  }
  doFreshApply(j);
}

function doFreshApply(j) {
  closeModal();
  // Auto-add to tracker as Applied
  applications.unshift({ id: Date.now(), sourceId: String(j.id), title: j.title, company: j.company, date: todayLabel(), status: 'Applied', notes: '', url: j.url });
  saveApps();
  coverContext = `${j.title} at ${j.company}. Location: ${j.location}. ${j.description ? j.description.slice(0,250) : ''}`;
  coverLetter = '';
  resumeSubTab = 'cover';
  switchTab('resume');
  toast('Added to tracker — good luck! 🌿');
}

function doApplyAgain(id) {
  const j = jobs.find(x => String(x.id) === String(id));
  if (!j) return;
  // Remove old entry and add fresh one
  applications = applications.filter(a => a.sourceId !== String(j.id));
  saveApps();
  doFreshApply(j);
}

function todayLabel() {
  const d = new Date();
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// ─────────────────────────────────────────
// TRACKER TAB
// ─────────────────────────────────────────
function renderTracker() {
  const statuses = ['Saved','Applied','Interviewing','Offer','Rejected'];
  const counts = {};
  statuses.forEach(s => counts[s] = applications.filter(a=>a.status===s).length);

  const colDefs = [
    { status:'Saved',        color:'#8B5CF6', bg:'#F5F3FF', text:'#5B21B6', empty:'Drop roles here to save for later' },
    { status:'Applied',      color:'#4F46E5', bg:'#EEF2FF', text:'#4F46E5', empty:'Applied roles appear here' },
    { status:'Interviewing', color:'#D97706', bg:'#FFF7ED', text:'#C2410C', empty:'Fingers crossed 🤞' },
    { status:'Offer',        color:'#16A34A', bg:'#F0FDF4', text:'#166534', empty:'Offers land here 🎉' },
    { status:'Rejected',     color:'#9CA3AF', bg:'#F9FAFB', text:'#6B7280', empty:'Onwards and upwards' },
  ];

  const isKanban = trackerView === 'kanban';

  const viewToggle = '<div class="tracker-view-toggle">'
    + '<button class="tvt-btn' + (!isKanban ? ' active' : '') + '" onclick="setTrackerView(&quot;list&quot;)">☰</button>'
    + '<button class="tvt-btn' + (isKanban ? ' active' : '') + '" onclick="setTrackerView(&quot;kanban&quot;)">⊞</button>'
    + '</div>';

  const header = '<div class="tracker-top">'
    + '<div class="tracker-top-title">Pipeline</div>'
    + '<div class="tracker-top-right">'
    + viewToggle
    + '<button class="add-btn" onclick="showAddModal()">+ Add</button>'
    + '</div>'
    + '</div>';

  if (applications.length === 0) {
    return header + '<div class="empty-state">'
      + '<div class="empty-state-art">' + emptyTrackerSvg() + '</div>'
      + '<div class="empty-state-title">Your pipeline is empty</div>'
      + '<div class="empty-state-sub">Search for jobs and tap "+ Track" to start building your pipeline.</div>'
      + '<button class="empty-state-btn" onclick="switchTab(&quot;search&quot;)">Browse Jobs →</button>'
      + '</div>';
  }

  if (isKanban) {
    const cols = colDefs.map(function(col) {
      const apps = applications.filter(function(a) { return a.status === col.status; });
      const cards = apps.map(function(a) {
        return '<div class="kb-card" draggable="true" data-id="' + a.id + '" data-status="' + col.status + '">'
          + '<button class="kb-card-del" onclick="event.stopPropagation();deleteApp(' + a.id + ')" title="Remove">✕</button>'
          + '<div class="kb-card-accent" style="background:' + col.color + '"></div>'
          + '<div class="kb-card-title">' + esc(a.title) + '</div>'
          + '<div class="kb-card-co">' + esc(a.company) + '</div>'
          + '<div class="kb-card-footer">'
          + '<div class="kb-card-date">' + esc(a.date) + '</div>'
          + '<button class="kb-card-move" onclick="event.stopPropagation();showMoveSheet(' + a.id + ')">Move ›</button>'
          + '</div>'
          + '</div>';
      }).join('');
      const emptyHtml = apps.length === 0 ? '<div class="kb-empty">' + col.empty + '</div>' : '';
      return '<div class="kb-col" data-status="' + col.status + '">'
        + '<div class="kb-col-header">'
        + '<span class="kb-col-title" style="color:' + col.text + '">' + col.status + '</span>'
        + '<span class="kb-col-count" style="background:' + col.bg + ';color:' + col.text + '">' + apps.length + '</span>'
        + '</div>'
        + cards + emptyHtml
        + '<button class="kb-add" onclick="showAddModal()">+ Add</button>'
        + '</div>';
    }).join('');

    return header + '<div class="kb-wrap"><div class="kb-board">' + cols + '</div></div>';
  }

  // List view
  const sectionColors = {
    Saved: { bar:'#8B5CF6', bg:'#F5F3FF', text:'#5B21B6' },
    Applied: { bar:'#4F46E5', bg:'#EEF2FF', text:'#4F46E5' },
    Interviewing: { bar:'#D97706', bg:'#FFF7ED', text:'#C2410C' },
    Offer: { bar:'#16A34A', bg:'#F0FDF4', text:'#166534' },
    Rejected: { bar:'#9CA3AF', bg:'#F9FAFB', text:'#6B7280' },
  };

  const sectionsHtml = statuses.map(function(s) {
    const apps = applications.filter(function(a) { return a.status === s; });
    if (apps.length === 0) return '';
    const sc = sectionColors[s];
    const cards = apps.map(function(a) {
      return '<div class="app-card">'
        + '<div class="app-status-bar" style="background:' + sc.bar + '"></div>'
        + '<div class="app-info">'
        + '<div class="app-title">' + esc(a.title) + '</div>'
        + '<div class="app-company">' + esc(a.company) + '</div>'
        + (a.notes ? '<div class="app-notes">' + esc(a.notes) + '</div>' : '')
        + '</div>'
        + '<div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px;flex-shrink:0">'
        + '<div style="display:flex;align-items:center;gap:4px">'
        + '<div class="app-date">' + esc(a.date) + '</div>'
        + '<button class="app-del-btn" onclick="deleteApp(' + a.id + ')" title="Remove">✕</button>'
        + '</div>'
        + '<select class="status-select" onchange="updateStatus(' + a.id + ',this.value)" style="color:' + sc.text + '">'
        + statuses.map(function(st) { return '<option value="' + st + '"' + (a.status === st ? ' selected' : '') + '>' + st + '</option>'; }).join('')
        + '</select>'
        + '</div>'
        + '</div>';
    }).join('');
    return '<div class="tracker-section-label" style="color:' + sc.text + '">'
      + s + '<span class="tsl-count" style="background:' + sc.bg + ';color:' + sc.text + '">' + apps.length + '</span>'
      + '</div>' + cards;
  }).join('');

  return header + sectionsHtml;
}


function updateStatus(id, status) {
  const a = applications.find(a=>a.id===id);
  if (a) { a.status = status; saveApps(); render(); }
}

function deleteApp(id) {
  const a = applications.find(a=>a.id===id);
  if (!a) return;
  if (!confirm('Remove "' + a.title + '" at ' + a.company + '?')) return;
  applications = applications.filter(a=>a.id!==id);
  saveApps(); render();
  toast('Removed ✓');
}

function showMoveSheet(id) {
  const a = applications.find(x=>x.id===id);
  if (!a) return;
  const colDefs = [
    { status:'Saved',        color:'#8B5CF6' },
    { status:'Applied',      color:'#4F46E5' },
    { status:'Interviewing', color:'#D97706' },
    { status:'Offer',        color:'#16A34A' },
    { status:'Rejected',     color:'#9CA3AF' },
  ];
  const opts = colDefs.map(function(c) {
    const isCurrent = a.status === c.status;
    return '<button class="move-sheet-opt' + (isCurrent ? ' current' : '') + '" onclick="moveAppTo(' + id + ',\'' + c.status + '\')">'
      + '<span class="move-sheet-dot" style="background:' + c.color + '"></span>'
      + c.status
      + (isCurrent ? ' <span style="margin-left:auto;font-size:12px;opacity:0.6">current</span>' : '')
      + '</button>';
  }).join('');
  showModal('<div class="modal-sheet">'
    + '<div class="modal-handle"></div>'
    + '<h3 style="margin-bottom:4px">' + esc(a.title) + '</h3>'
    + '<p style="font-size:13px;color:var(--ink-muted);margin-bottom:16px">' + esc(a.company) + '</p>'
    + '<div class="move-sheet-opts">' + opts + '</div>'
    + '<button class="move-sheet-del" onclick="deleteApp(' + id + ');closeModal()">Remove from pipeline</button>'
    + '</div>');
}

function moveAppTo(id, status) {
  const a = applications.find(x=>x.id===id);
  if (!a) return;
  const prev = a.status;
  a.status = status;
  saveApps();
  closeModal();
  if (status === 'Offer' && prev !== 'Offer') { setTimeout(triggerConfetti, 100); }
  toast(a.company + ' → ' + status + ' ✓');
  render();
}

function showAddModal() {
  showModal(`
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <h3>Add Application</h3>
      <div class="form-field"><label class="form-label">Job Title</label><input class="form-input" id="m-title" placeholder="e.g. Product Designer" /></div>
      <div class="form-field"><label class="form-label">Company</label><input class="form-input" id="m-company" placeholder="e.g. Notion" /></div>
      <div class="form-field"><label class="form-label">Status</label>
        <select class="form-select" id="m-status">${Object.keys(STATUS_COLORS).map(s=>`<option>${s}</option>`).join('')}</select></div>
      <div class="form-field"><label class="form-label">Notes</label><input class="form-input" id="m-notes" placeholder="Optional…" /></div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeModal()">Cancel</button>
        <button class="btn-confirm" onclick="confirmAdd()">Add</button>
      </div>
    </div>`);
}

function confirmAdd() {
  const title = (document.getElementById('m-title')?.value||'').trim();
  const company = (document.getElementById('m-company')?.value||'').trim();
  const status = document.getElementById('m-status')?.value || 'Applied';
  const notes = (document.getElementById('m-notes')?.value||'').trim();
  if (!title || !company) { toast('Please fill in title and company'); return; }
  applications.unshift({ id: Date.now(), title, company, date: 'Today', status, notes, url: '' });
  saveApps(); closeModal();
  switchTab('tracker');
}

// ─────────────────────────────────────────
// RESUME TAB
// ─────────────────────────────────────────
function renderResume() {
  const tabs = [
    { k:'resume', v:'My Resume' },
    { k:'cover', v:'Cover Letter' },
    { k:'match', v:'Match Score' },
    { k:'quickfill', v:'Quick Fill' },
  ].map(({k,v}) => `<button class="rtab${resumeSubTab===k?' active':''}" onclick="setResumeTab('${k}')">${v}</button>`).join('');

  let body = '';
  if (resumeSubTab === 'resume') {
    let statusBanner = '';
    if (resumeParseStatus === 'parsing') {
      statusBanner = `<div class="parsing-overlay"><div class="spinner" style="width:16px;height:16px;border-color:#fed7aa;border-top-color:#C2410C;flex-shrink:0"></div><span class="ps-text">Reading your resume…</span></div>`;
    } else if (resumeParseStatus === 'done') {
      statusBanner = `<div class="parse-status"><span class="ps-icon">✓</span><div><div class="ps-text">Parsed successfully</div><div class="ps-sub">${esc(resumeFileName)} — edit below if needed</div></div></div>`;
    } else if (resumeParseStatus === 'error') {
      statusBanner = `<div class="parse-status parse-error"><span class="ps-icon">X</span><div><div class="ps-text">Couldn't parse that file</div><div class="ps-sub">${esc(resumeParseMsg)}</div></div></div>`;
    }

    body = `
      ${statusBanner}
      <div class="resume-dropzone" id="resume-dropzone">
        <input type="file" id="resume-file-input" accept=".pdf,.doc,.docx,.txt" onchange="handleResumeFile(this.files[0])" />
        <div class="dz-icon">📄</div>
        <div class="dz-title">Upload your resume</div>
        <div class="dz-hint">Drag & drop or tap to browse</div>
        <div class="dz-types">
          <span class="dz-type">PDF</span>
          <span class="dz-type">DOCX</span>
          <span class="dz-type">TXT</span>
        </div>
      </div>
      <div class="section-label" style="margin-top:4px">Resume Text</div>
      <p style="font-size:12px;color:var(--ink-muted);margin-bottom:10px;line-height:1.55">Used to generate cover letters and quick-fill fields. Edit directly or upload a file above.</p>
      <textarea id="resume-ta" rows="14">${esc(resumeText)}</textarea>`;
  } else if (resumeSubTab === 'cover') {
    const hasKey = !!apiKey;
    const btnContent = generating
      ? `<div class="spinner" style="width:16px;height:16px;border-color:rgba(255,255,255,0.3);border-top-color:#fff"></div> Generating…`
      : '✦ Generate Cover Letter';
    const noKeyNotice = !hasKey ? `
      <div style="display:flex;align-items:center;gap:10px;background:#FFFBEB;border:1.5px solid #FDE68A;border-radius:12px;padding:12px 14px;margin-bottom:14px">
        <span style="font-size:16px">🔑</span>
        <div style="flex:1;font-size:12px;color:#92400E;line-height:1.5">Add your <strong>Anthropic API key</strong> in Settings to enable AI generation.</div>
        <button onclick="showApiKeyModal()" style="font-size:12px;color:var(--green);font-weight:600;background:none;border:none;cursor:pointer;white-space:nowrap">Add key →</button>
      </div>` : '';
    body = `
      ${noKeyNotice}
      <div class="section-label">Job Details</div>
      <p style="font-size:12px;color:var(--ink-muted);margin-bottom:10px;line-height:1.55">Paste the job title, company, and key requirements.</p>
      <textarea id="cover-ctx" rows="4" placeholder="e.g. Senior Designer at Notion. Looking for 5+ years of Figma experience...">${esc(coverContext)}</textarea>
      <button class="generate-btn" id="gen-btn" onclick="generateCL()" ${generating||!hasKey?'disabled':''}>${btnContent}</button>
      ${coverLetter
        ? `<div style="margin-top:16px"><div class="section-label">Your Cover Letter</div><div class="cl-output" id="cl-out">${esc(coverLetter)}</div><button class="copy-btn" onclick="copyCL()">Copy to clipboard</button></div>`
        : (!generating ? `<p style="font-size:12px;color:var(--ink-faint);margin-top:14px;text-align:center;line-height:1.6">Your resume is included automatically.</p>` : '')}`;
  } else if (resumeSubTab === 'match') {
    const hasKey = !!apiKey;
    const noKeyNotice = !hasKey ? '<div style="display:flex;align-items:center;gap:10px;background:#FFFBEB;border:1.5px solid #FDE68A;border-radius:12px;padding:12px 14px;margin-bottom:14px"><span style="font-size:16px">🔑</span><div style="flex:1;font-size:12px;color:#92400E;line-height:1.5">Add your <strong>Anthropic API key</strong> to enable match scoring.</div><button onclick="showApiKeyModal()" style="font-size:12px;color:var(--green);font-weight:600;background:none;border:none;cursor:pointer;white-space:nowrap">Add key →</button></div>' : '';
    body = noKeyNotice
      + '<div class="section-label">Job Description</div>'
      + '<p style="font-size:12px;color:var(--ink-muted);margin-bottom:10px;line-height:1.55">Paste the full job description to score how well your resume matches it.</p>'
      + '<textarea id="match-jd" rows="6" placeholder="Paste job description here…"></textarea>'
      + '<button class="generate-btn" style="margin-top:10px" onclick="runMatchScore()" ' + (!hasKey ? 'disabled' : '') + '>✦ Score My Match</button>'
      + '<div id="match-score-area"></div>';
  } else {
    const fields = parseFields(resumeText);
    body = `
      <div class="quick-fill-box">
        <h4>Quick Fill Fields</h4>
        <p>Tap "Copy" next to any field, then paste into a job application form.</p>
        ${fields.map(f => `
          <div class="fill-field">
            <div class="fill-label">${esc(f.label)}</div>
            <div class="fill-value">
              <span class="fill-text">${esc(f.value)}</span>
              <button class="fill-copy" onclick="copyField(this,'${f.value.replace(/'/g,"\\'").replace(/\n/g,' ')}')">Copy</button>
            </div>
          </div>`).join('')}
      </div>
      <p style="font-size:12px;color:#ccc;margin-top:12px;text-align:center;line-height:1.5">Parsed from your resume. Edit in "My Resume" to update.</p>`;
  }
  return `<div class="rtabs">${tabs}</div>${body}`;
}

function setResumeTab(t) {
  if (resumeSubTab === 'cover') { const ctx = document.getElementById('cover-ctx'); if (ctx) coverContext = ctx.value; }
  if (resumeSubTab === 'resume') { const ta = document.getElementById('resume-ta'); if (ta) { resumeText = ta.value; saveResume(); } }
  resumeSubTab = t; render();
}

function parseFields(text) {
  const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
  const name = lines[0] || '';
  const contact = lines[1] || '';
  const email = (contact.match(/[\w.+-]+@[\w-]+\.[a-z]+/i)||[])[0] || '';
  const phone = (contact.match(/[\d()+.\-\s]{7,}/)||[])[0]?.trim() || '';
  const linkedin = (contact.match(/linkedin\.com\/in\/[\w-]+/i)||[])[0] || '';
  const expIdx = lines.findIndex(l=>/experience/i.test(l));
  const firstJob = expIdx >= 0 ? lines[expIdx+1] || '' : '';
  const skillIdx = lines.findIndex(l=>/skills/i.test(l));
  const skills = skillIdx >= 0 ? lines[skillIdx+1] || '' : '';
  const eduIdx = lines.findIndex(l=>/education/i.test(l));
  const edu = eduIdx >= 0 ? lines[eduIdx+1] || '' : '';
  return [
    { label:'Full Name', value:name },
    { label:'Email', value:email },
    { label:'Phone', value:phone },
    { label:'LinkedIn URL', value: linkedin ? 'https://'+linkedin : '' },
    { label:'Most Recent Role', value:firstJob },
    { label:'Education', value:edu },
    { label:'Skills', value:skills },
  ].filter(f=>f.value);
}

async function generateCL() {
  const ctx = document.getElementById('cover-ctx'); if (ctx) coverContext = ctx.value;
  const ta = document.getElementById('resume-ta'); if (ta) { resumeText = ta.value; saveResume(); }
  if (!apiKey) { showApiKeyModal(); return; }
  generating = true; render();
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1000,
        messages: [{ role:'user', content:
          `Write a concise, compelling cover letter in 3 short paragraphs. Professional and personalized. Return only the cover letter text — no subject line, no extra formatting.\n\nJob: ${coverContext||'a role at a tech company'}\n\nResume:\n${resumeText}` }]
      })
    });
    if (!res.ok) {
      let msg = 'Generation failed.';
      try { const e = await res.json(); msg = e?.error?.message || msg; } catch(_) {}
      coverLetter = msg;
    } else {
      const data = await res.json();
      coverLetter = data.content?.[0]?.text || 'Could not generate — please try again.';
    }
  } catch(e) { coverLetter = 'Generation failed. Check your connection and API key.'; }
  generating = false; render();
}

function copyCL() {
  const el = document.getElementById('cl-out');
  if (el) navigator.clipboard.writeText(el.textContent).then(()=>toast('Copied ✓'));
}

function copyField(btn, val) {
  navigator.clipboard.writeText(val).then(() => {
    const orig = btn.textContent; btn.textContent = '✓';
    setTimeout(()=>btn.textContent=orig, 1500);
    toast('Copied ✓');
  });
}

// ─────────────────────────────────────────
// API KEY MODAL
// ─────────────────────────────────────────
function showDarkModeInSettings() {
  const btn = document.getElementById('dark-toggle-btn');
  if (btn) btn.className = 'dark-toggle' + (darkMode ? ' on' : '');
}

function showApiKeyModal() {
  showModal(`
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <h3>Anthropic API Key</h3>
      <p style="font-size:13px;color:#888;margin-bottom:18px;line-height:1.6">
        Your key is stored only in your browser (localStorage) and sent directly to Anthropic. It never touches any other server.
      </p>
      <div class="form-field">
        <label class="form-label">API Key</label>
        <div class="key-input-wrap">
          <input type="password" id="api-key-input" placeholder="sk-ant-..." value="${esc(apiKey)}" autocomplete="off" />
          <button class="key-toggle" onclick="toggleKeyVisibility()" id="key-toggle-btn">Show</button>
        </div>
        <p class="key-hint">
          Get your key at <a href="https://console.anthropic.com/settings/keys" target="_blank">console.anthropic.com</a>. 
          Required for cover letter generation and resume parsing.
        </p>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="clearApiKey()">Clear key</button>
        <button class="btn-confirm" onclick="saveApiKeyFromModal()">Save key</button>
      </div>
    </div>`);
}

function toggleKeyVisibility() {
  const inp = document.getElementById('api-key-input');
  const btn = document.getElementById('key-toggle-btn');
  if (!inp) return;
  if (inp.type === 'password') { inp.type = 'text'; btn.textContent = 'Hide'; }
  else { inp.type = 'password'; btn.textContent = 'Show'; }
}

function saveApiKeyFromModal() {
  const val = (document.getElementById('api-key-input')?.value || '').trim();
  if (!val) { toast('Please enter an API key'); return; }
  if (!val.startsWith('sk-ant-')) { toast('Key should start with sk-ant-…'); return; }
  apiKey = val;
  saveApiKey();
  closeModal();
  render();
  toast('API key saved ✓');
}

function clearApiKey() {
  apiKey = '';
  saveApiKey();
  closeModal();
  render();
  toast('API key cleared');
}

// ─────────────────────────────────────────
// MODAL
// ─────────────────────────────────────────
function showModal(html) {
  document.getElementById('modal-inner').innerHTML = html;
  document.getElementById('modal-bg').style.display = 'flex';
}
function closeModal() { document.getElementById('modal-bg').style.display = 'none'; }

// ─────────────────────────────────────────
// LIVE EVENTS
// ─────────────────────────────────────────
function attachLiveEvents() {
  const ta = document.getElementById('resume-ta');
  if (ta) ta.addEventListener('input', () => { resumeText = ta.value; saveResume(); });
  const si = document.getElementById('search-input');
  if (si) si.addEventListener('keydown', e => { if (e.key==='Enter') doSearch(); });
  setupDropZone();
}


// ─────────────────────────────────────────
// LOCATION AUTOCOMPLETE (Nominatim)
// ─────────────────────────────────────────
let locTimer = null;

function locationTyped(val) {
  prefs.location = val;
  clearTimeout(locTimer);
  const sug = document.getElementById('loc-suggestions');
  if (!sug) return;
  if (val.length < 2) { sug.style.display = 'none'; return; }
  locTimer = setTimeout(() => fetchLocSuggestions(val), 300);
}

async function fetchLocSuggestions(query) {
  const sug = document.getElementById('loc-suggestions');
  if (!sug) return;
  try {
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&featuretype=city&addressdetails=1`;
    const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
    const data = await res.json();
    // Filter to cities/towns only, deduplicate by display name
    const seen = new Set();
    const results = data.filter(r => {
      const type = r.type || r.class;
      const label = buildLocLabel(r);
      if (seen.has(label)) return false;
      seen.add(label);
      return ['city','town','village','municipality','administrative'].includes(type) ||
             r.class === 'place' || r.class === 'boundary';
    }).slice(0, 5);

    if (results.length === 0) { sug.style.display = 'none'; return; }

    sug.innerHTML = results.map((r, i) => {
      const label = buildLocLabel(r);
      return `<div onclick="selectLocation('${label.replace(/'/g,"\'")}') "
        style="padding:12px 16px;font-size:14px;color:#333;cursor:pointer;border-bottom:${i < results.length-1 ? '1px solid #F0F0EE' : 'none'};font-family:'DM Sans',sans-serif"
        onmouseenter="this.style.background='#F5F0E8'" onmouseleave="this.style.background=''">${label}</div>`;
    }).join('');
    sug.style.display = 'block';
  } catch(e) {
    console.log('Location fetch failed', e);
  }
}

function buildLocLabel(r) {
  const a = r.address || {};
  const city = a.city || a.town || a.village || a.municipality || r.display_name.split(',')[0];
  const state = a.state || a.region || '';
  const country = a.country_code?.toUpperCase() || '';
  if (country === 'US' && state) return `${city}, ${state}`;
  if (state) return `${city}, ${state}, ${country}`;
  return `${city}, ${country}`;
}

function selectLocation(label) {
  prefs.location = label;
  const inp = document.getElementById('ob-location');
  if (inp) inp.value = label;
  const sug = document.getElementById('loc-suggestions');
  if (sug) sug.style.display = 'none';
  updateObNextBtn();
}

// ─────────────────────────────────────────
// RESUME FILE UPLOAD & PARSING
// ─────────────────────────────────────────
function setupDropZone() {
  const dz = document.getElementById('resume-dropzone');
  if (!dz) return;

  dz.addEventListener('dragover', e => {
    e.preventDefault();
    dz.classList.add('drag-over');
  });
  dz.addEventListener('dragleave', e => {
    if (!dz.contains(e.relatedTarget)) dz.classList.remove('drag-over');
  });
  dz.addEventListener('drop', e => {
    e.preventDefault();
    dz.classList.remove('drag-over');
    const file = e.dataTransfer?.files?.[0];
    if (file) handleResumeFile(file);
  });
}

async function handleResumeFile(file) {
  if (!file) return;
  const ext = file.name.split('.').pop().toLowerCase();
  if (!['pdf','doc','docx','txt'].includes(ext)) {
    resumeParseStatus = 'error';
    resumeParseMsg = 'Unsupported file type. Please use PDF, DOCX, or TXT.';
    render(); return;
  }

  resumeFileName = file.name;
  resumeParseStatus = 'parsing';
  render();

  try {
    let rawText = '';
    if (ext === 'txt') {
      rawText = await file.text();
    } else if (ext === 'pdf') {
      rawText = await extractTextFromPDF(file);
    } else {
      rawText = await extractTextFromDocx(file);
    }

    if (!rawText || rawText.trim().length < 30) {
      throw new Error('Could not extract text from file. Try saving as TXT instead.');
    }

    await parseResumeWithClaude(rawText);
  } catch(e) {
    console.error(e);
    resumeParseStatus = 'error';
    resumeParseMsg = e.message || 'Something went wrong reading the file.';
    render();
  }
}

// Extract text from PDF using PDF.js (loaded from CDN)
async function extractTextFromPDF(file) {
  // Dynamically load PDF.js if not already loaded
  if (!window.pdfjsLib) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js';
      script.onload = resolve;
      script.onerror = () => reject(new Error('Could not load PDF reader library'));
      document.head.appendChild(script);
    });
    window.pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }

  const arrayBuffer = await file.arrayBuffer();
  const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  let fullText = '';

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const content = await page.getTextContent();
    const pageText = content.items.map(item => item.str).join(' ');
    fullText += pageText + '\n';
  }

  return fullText.trim();
}

// Extract readable text from a DOCX file (ZIP of XML)
async function extractTextFromDocx(file) {
  const buf = await file.arrayBuffer();
  const bytes = new Uint8Array(buf);
  const decoder = new TextDecoder('utf-8', { fatal: false });
  const raw = decoder.decode(bytes);

  const stripped = raw
    .replace(/<w:br[^>]*\/>/g, '\n')
    .replace(/<w:p[ >][^<]*/g, '\n')
    .replace(/<[^>]+>/g, ' ')
    .replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"')
    .replace(/&#x[0-9a-f]+;/gi,'')
    .replace(/ {2,}/g, ' ')
    .split('\n').map(l => l.trim()).filter(Boolean).join('\n');

  if (!stripped || stripped.length < 50) {
    throw new Error('Could not read DOCX content. Try saving as PDF or TXT instead.');
  }
  return stripped;
}

async function parseResumeWithClaude(plainText) {
  if (!apiKey) throw new Error('No API key set — tap the ⚙ icon to add your Anthropic key.');
  const PROMPT = 'Extract and reformat this resume into clean plain text. Preserve ALL information. Put the person\'s name and contact info at the top, then use clear sections: EXPERIENCE, EDUCATION, SKILLS, etc. Return ONLY the formatted resume — no commentary, no markdown symbols.';

  const res = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true',
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 2000,
      messages: [{ role: 'user', content: `${PROMPT}\n\nRESUME TEXT:\n${plainText.slice(0, 8000)}` }]
    })
  });

  if (!res.ok) {
    let errMsg = `API error ${res.status}`;
    try { const e = await res.json(); errMsg = e?.error?.message || errMsg; } catch(_) {}
    throw new Error(errMsg);
  }

  const data = await res.json();
  const parsed = data.content?.[0]?.text;
  if (!parsed) throw new Error('No content returned from Claude');

  resumeText = parsed;
  saveResume();
  resumeParseStatus = 'done';
  render();
  toast('Resume imported ✓');
}


// ─────────────────────────────────────────
// AUTH (Demo Mode)
// ─────────────────────────────────────────
let currentUser = null;

function authGetUsers() {
  try { return JSON.parse(localStorage.getItem('grove_users') || '{}'); } catch(e) { return {}; }
}
function authSaveUsers(u) { try { localStorage.setItem('grove_users', JSON.stringify(u)); } catch(e) {} }
function authSaveSession(u) { try { localStorage.setItem('grove_session', JSON.stringify(u)); } catch(e) {} }
function authClearSession() { try { localStorage.removeItem('grove_session'); } catch(e) {} }
function authGetSession() { try { return JSON.parse(localStorage.getItem('grove_session') || 'null'); } catch(e) { return null; } }

// Simple hash (demo only — not cryptographically safe)
async function demoHash(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str + 'grove_salt_v1'));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function authSwitchTab(tab) {
  document.getElementById('auth-signin').style.display = tab === 'in' ? 'block' : 'none';
  document.getElementById('auth-signup').style.display = tab === 'up' ? 'block' : 'none';
  document.getElementById('auth-tab-in').classList.toggle('active', tab === 'in');
  document.getElementById('auth-tab-up').classList.toggle('active', tab === 'up');
  clearAuthErrors();
}

function clearAuthErrors() {
  document.querySelectorAll('.auth-error').forEach(e => { e.textContent = ''; e.classList.remove('show'); });
  document.querySelectorAll('.auth-input').forEach(e => e.classList.remove('error'));
}

function showAuthError(id, msg) {
  const el = document.getElementById(id);
  if (el) { el.textContent = msg; el.classList.add('show'); }
}

function checkPwStrength(pw) {
  const box = document.getElementById('pw-strength');
  if (!box) return;
  box.style.display = pw.length > 0 ? 'block' : 'none';

  const hasLen = pw.length >= 8;
  const hasUpper = /[A-Z]/.test(pw);
  const hasNum = /[0-9]/.test(pw);
  const hasSpecial = /[^A-Za-z0-9]/.test(pw);

  document.getElementById('req-len').classList.toggle('met', hasLen);
  document.getElementById('req-upper').classList.toggle('met', hasUpper);
  document.getElementById('req-num').classList.toggle('met', hasNum);
  document.getElementById('req-special').classList.toggle('met', hasSpecial);

  const score = [hasLen, hasUpper, hasNum, hasSpecial].filter(Boolean).length;
  const bars = ['pwb1','pwb2','pwb3','pwb4'];
  const levels = ['weak','fair','good','strong'];
  const labels = ['Too weak','Fair','Good','Strong 💪'];
  const colors = ['weak','fair','good','strong'];

  bars.forEach((id, i) => {
    const el = document.getElementById(id);
    el.className = 'pw-bar' + (i < score ? ' ' + colors[score - 1] : '');
  });
  const lbl = document.getElementById('pw-label');
  if (lbl) { lbl.textContent = pw.length === 0 ? '' : labels[score - 1] || 'Too short'; lbl.style.color = score >= 3 ? '#16a34a' : score === 2 ? '#D4780A' : '#C0392B'; }
}

function pwScore(pw) {
  return [pw.length >= 8, /[A-Z]/.test(pw), /[0-9]/.test(pw), /[^A-Za-z0-9]/.test(pw)].filter(Boolean).length;
}

async function doSignIn() {
  clearAuthErrors();
  const email = document.getElementById('si-email').value.trim();
  const pw = document.getElementById('si-pw').value;
  let valid = true;

  if (!email || !/^[^@]+@[^@]+\.[^@]+$/.test(email)) {
    showAuthError('si-email-err', 'Enter a valid email address');
    document.getElementById('si-email').classList.add('error');
    valid = false;
  }
  if (!pw) {
    showAuthError('si-pw-err', 'Enter your password');
    document.getElementById('si-pw').classList.add('error');
    valid = false;
  }
  if (!valid) return;

  const users = authGetUsers();
  const user = users[email.toLowerCase()];
  if (!user) { showAuthError('si-general-err', 'No account found with that email'); return; }

  const hash = await demoHash(pw);
  if (hash !== user.pwHash) { showAuthError('si-general-err', 'Incorrect password'); return; }

  currentUser = { email: user.email, name: user.name };
  authSaveSession(currentUser);
  enterApp();
}

async function doSignUp() {
  clearAuthErrors();
  const name = document.getElementById('su-name').value.trim();
  const email = document.getElementById('su-email').value.trim();
  const pw = document.getElementById('su-pw').value;
  const pw2 = document.getElementById('su-pw2').value;
  let valid = true;

  if (!name || name.length < 2) {
    showAuthError('su-name-err', 'Enter your name');
    document.getElementById('su-name').classList.add('error');
    valid = false;
  }
  if (!email || !/^[^@]+@[^@]+\.[^@]+$/.test(email)) {
    showAuthError('su-email-err', 'Enter a valid email address');
    document.getElementById('su-email').classList.add('error');
    valid = false;
  }
  if (!pw) {
    showAuthError('su-pw-err', 'Enter a password');
    document.getElementById('su-pw').classList.add('error');
    valid = false;
  }
  if (pw !== pw2) {
    showAuthError('su-pw2-err', 'Passwords don\'t match');
    document.getElementById('su-pw2').classList.add('error');
    valid = false;
  }
  if (!valid) return;

  const users = authGetUsers();
  if (users[email.toLowerCase()]) {
    showAuthError('su-general-err', 'An account with that email already exists');
    return;
  }

  const pwHash = await demoHash(pw);
  users[email.toLowerCase()] = { email, name, pwHash, createdAt: Date.now() };
  authSaveUsers(users);

  currentUser = { email, name };
  authSaveSession(currentUser);
  enterApp();
}


function updateTopbarAuth() {
  const el = document.getElementById('topbar-right');
  if (!el) return;
  if (currentUser) {
    const initial = (currentUser.name || currentUser.email || '?')[0].toUpperCase();
    const shortName = (currentUser.name || currentUser.email).split(' ')[0];
    el.innerHTML = `<button class="user-pill" onclick="showAccountModal()">
      <div class="user-avatar">${initial}</div>
      <span class="user-name">${esc(shortName)}</span>
    </button>`;
  } else {
    el.innerHTML = `<div class="topbar-auth-btns">
      <button class="topbar-btn-ghost" onclick="showAuthScreen('in')">Sign In</button>
      <button class="topbar-btn-solid" onclick="showAuthScreen('up')">Join Free</button>
    </div>`;
  }
}

function showAuthScreen(tab) {
  authSwitchTab(tab || 'in');
  const screen = document.getElementById('auth-screen');
  screen.style.opacity = '0';
  screen.style.transform = 'translateY(-12px)';
  screen.style.display = 'flex';
  requestAnimationFrame(() => {
    screen.style.transition = 'opacity 0.25s, transform 0.25s';
    screen.style.opacity = '1';
    screen.style.transform = 'none';
  });
}
function browseAsGuest() {
  currentUser = null;
  const screen = document.getElementById('auth-screen');
  screen.style.transition = 'opacity 0.3s, transform 0.3s';
  screen.style.opacity = '0';
  screen.style.transform = 'translateY(-12px)';
  setTimeout(() => { screen.style.display = 'none'; }, 300);
  updateTopbarAuth();
  // Always show onboarding for guests so they set their prefs
  setTimeout(() => { showOnboarding(); }, 350);
}

function enterApp() {
  const screen = document.getElementById('auth-screen');
  screen.style.transition = 'opacity 0.3s, transform 0.3s';
  screen.style.opacity = '0';
  screen.style.transform = 'translateY(-12px)';
  setTimeout(() => { screen.style.display = 'none'; }, 300);
  updateUserPill();
  updateTopbarAuth();
  // Always show onboarding after sign in / sign up
  setTimeout(() => { showOnboarding(); }, 350);
}

function goToJobs() {
  const hasPrefs = prefs.fields.length > 0 || prefs.levels.length > 0;
  if (!hasPrefs) {
    showOnboarding();
  } else {
    switchTab('search');
  }
}

function showOnboarding() {
  obStep = 0;
  const ob = document.getElementById('onboarding');
  ob.style.display = 'flex';
  ob.style.opacity = '1';
  ob.style.transform = 'none';
  renderOnboarding();
}

function signOut() {
  authClearSession();
  currentUser = null;
  closeModal();
  const screen = document.getElementById('auth-screen');
  screen.style.display = 'flex';
  screen.style.opacity = '1';
  screen.style.transform = 'none';
  // Reset to sign in tab
  authSwitchTab('in');
  document.getElementById('si-email').value = '';
  document.getElementById('si-pw').value = '';
  updateTopbarAuth();
}

function updateUserPill() {
  const pill = document.getElementById('user-pill');
  if (!pill || !currentUser) return;
  const initial = (currentUser.name || currentUser.email || '?')[0].toUpperCase();
  const shortName = (currentUser.name || currentUser.email).split(' ')[0];
  pill.innerHTML = `<div class="user-avatar">${initial}</div><span class="user-name">${esc(shortName)}</span>`;
  pill.style.display = 'flex';
}

function showAccountModal() {
  if (!currentUser) return;
  showModal(`
    <div class="modal-sheet">
      <div class="modal-handle"></div>
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px">
        <div class="user-avatar" style="width:48px;height:48px;font-size:20px;border-radius:50%;background:var(--green);display:flex;align-items:center;justify-content:center;color:#fff;font-family:Fraunces,serif;font-weight:700">${(currentUser.name||currentUser.email)[0].toUpperCase()}</div>
        <div>
          <div style="font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--ink)">${esc(currentUser.name || '')}</div>
          <div style="font-size:13px;color:var(--ink-muted)">${esc(currentUser.email)}</div>
        </div>
      </div>
      <div style="background:#FFFBEB;border:1px solid #FDE68A;border-radius:10px;padding:10px 14px;font-size:12px;color:#92400E;margin-bottom:20px;line-height:1.5">
        ⚡ <strong>Demo mode</strong> — your data is stored locally. Connect Firebase to sync across devices.
      </div>
      <button class="detail-btn outline" onclick="closeModal();signOut()" style="color:var(--red);border-color:#FECACA">Sign Out</button>
    </div>`);
}

// ─────────────────────────────────────────
// INIT
// ─────────────────────────────────────────
// Check for existing session
const savedSession = authGetSession();
document.getElementById('onboarding').style.display = 'none';
currentTab = 'home';
render();
const topbar = document.getElementById('main-topbar');
if (topbar) topbar.classList.add('home-tab');
document.getElementById('tab-home')?.classList.add('active');
['tab-search','tab-tracker','tab-resume'].forEach(id => document.getElementById(id)?.classList.remove('active'));

if (savedSession) {
  // Returning user — skip auth and onboarding, go straight to app
  currentUser = savedSession;
  updateUserPill();
  updateTopbarAuth();
} else {
  // New visit — show auth screen
  document.getElementById('auth-screen').style.display = 'flex';
  updateTopbarAuth();
}

// ── Tracker view state ──
let trackerView = 'kanban';
function setTrackerView(v) { trackerView = v; render(); }

// ── Dark mode ──
let darkMode = localStorage.getItem('grove_dark') === '1';
function applyDarkMode() {
  document.body.classList.toggle('dark', darkMode);
  document.querySelector('meta[name="theme-color"]').setAttribute('content', darkMode ? '#0F1410' : '#F7F3EC');
}
function toggleDark() {
  darkMode = !darkMode;
  localStorage.setItem('grove_dark', darkMode ? '1' : '0');
  applyDarkMode();
  // Update toggle button if visible
  const btn = document.getElementById('dark-toggle-btn');
  if (btn) btn.className = 'dark-toggle' + (darkMode ? ' on' : '');
}
applyDarkMode();

// ── Confetti ──
function triggerConfetti() {
  const colors = ['#004225','#22C55E','#F59E0B','#4F46E5','#EC4899','#F97316','#06B6D4'];
  for (let i = 0; i < 60; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.left = Math.random() * 100 + 'vw';
    el.style.background = colors[Math.floor(Math.random() * colors.length)];
    el.style.width = (6 + Math.random() * 6) + 'px';
    el.style.height = (6 + Math.random() * 6) + 'px';
    el.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    el.style.animationDuration = (1.5 + Math.random() * 2) + 's';
    el.style.animationDelay = (Math.random() * 0.5) + 's';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 4000);
  }
}

// ── Kanban drag init (called after render) ──
function initKanban() {
  document.querySelectorAll('.kb-card').forEach(function(card) {
    card.addEventListener('dragstart', function(e) {
      dragApp = parseInt(card.dataset.id);
      dragSourceStatus = card.dataset.status;
      setTimeout(function() { card.classList.add('dragging'); }, 0);
      e.dataTransfer.effectAllowed = 'move';
    });
    card.addEventListener('dragend', function() {
      card.classList.remove('dragging');
      document.querySelectorAll('.kb-col').forEach(function(c) { c.classList.remove('drag-over'); });
      dragApp = null;
    });
  });
  document.querySelectorAll('.kb-col').forEach(function(col) {
    col.addEventListener('dragover', function(e) {
      e.preventDefault();
      col.classList.add('drag-over');
    });
    col.addEventListener('dragleave', function(e) {
      if (!col.contains(e.relatedTarget)) col.classList.remove('drag-over');
    });
    col.addEventListener('drop', function(e) {
      e.preventDefault();
      col.classList.remove('drag-over');
      const newStatus = col.dataset.status;
      if (!dragApp) return;
      const app = applications.find(function(a) { return a.id === dragApp; });
      if (!app || app.status === newStatus) return;
      app.status = newStatus;
      saveApps();
      if (newStatus === 'Offer') { setTimeout(triggerConfetti, 100); }
      toast(app.company + ' → ' + newStatus + ' ✓');
      render();
    });
  });
}
let dragApp = null;
let dragSourceStatus = null;

// ── SVG empty state art ──
function emptyTrackerSvg() {
  return '<svg width="120" height="100" viewBox="0 0 120 100" fill="none" xmlns="http://www.w3.org/2000/svg">'
    + '<rect x="10" y="20" width="28" height="60" rx="6" fill="var(--surface)" stroke="var(--border)" stroke-width="1.5"/>'
    + '<rect x="46" y="32" width="28" height="48" rx="6" fill="var(--surface)" stroke="var(--border)" stroke-width="1.5"/>'
    + '<rect x="82" y="14" width="28" height="66" rx="6" fill="var(--surface)" stroke="var(--border)" stroke-width="1.5"/>'
    + '<rect x="14" y="28" width="20" height="3" rx="1.5" fill="var(--border)"/>'
    + '<rect x="14" y="35" width="14" height="3" rx="1.5" fill="var(--border)"/>'
    + '<rect x="50" y="40" width="20" height="3" rx="1.5" fill="var(--border)"/>'
    + '<rect x="50" y="47" width="14" height="3" rx="1.5" fill="var(--border)"/>'
    + '<rect x="86" y="22" width="20" height="3" rx="1.5" fill="var(--green)" opacity="0.4"/>'
    + '<rect x="86" y="29" width="14" height="3" rx="1.5" fill="var(--border)"/>'
    + '</svg>';
}

// ── Match Score ──
let matchScoreResult = null;
let matchScoring = false;

async function runMatchScore() {
  const jdEl = document.getElementById('match-jd');
  if (!jdEl || !jdEl.value.trim()) { toast('Paste a job description first'); return; }
  if (!apiKey) { showApiKeyModal(); return; }
  matchScoring = true;
  matchScoreResult = null;
  renderMatchScore();
  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true',
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 600,
        messages: [{ role: 'user', content:
          'Compare this resume against this job description. Respond ONLY in this exact JSON format, no other text:\n{"score":75,"verdict":"Strong match","summary":"2 sentence summary of fit","gaps":["gap 1","gap 2","gap 3"],"strengths":["strength 1","strength 2"]}\n\nRESUME:\n' + resumeText + '\n\nJOB DESCRIPTION:\n' + jdEl.value }]
      })
    });
    const data = await res.json();
    const raw = data.content?.[0]?.text || '{}';
    matchScoreResult = JSON.parse(raw.replace(/```json|```/g, '').trim());
  } catch(e) { matchScoreResult = { score: 0, verdict: 'Error', summary: 'Could not analyse. Check your API key.', gaps: [], strengths: [] }; }
  matchScoring = false;
  renderMatchScore();
}

function renderMatchScore() {
  const el = document.getElementById('match-score-area');
  if (!el) return;
  if (matchScoring) {
    el.innerHTML = '<div class="loader" style="padding:32px"><div class="spinner"></div><span>Analysing match…</span></div>';
    return;
  }
  if (!matchScoreResult) { el.innerHTML = ''; return; }
  const s = matchScoreResult;
  const score = Math.min(100, Math.max(0, s.score || 0));
  const color = score >= 75 ? '#16A34A' : score >= 50 ? '#D97706' : '#DC2626';
  const r = 28; const circ = 2 * Math.PI * r;
  const dash = (score / 100) * circ;
  el.innerHTML = '<div class="match-score-box">'
    + '<div class="match-score-ring">'
    + '<div class="score-circle">'
    + '<svg width="72" height="72" viewBox="0 0 72 72">'
    + '<circle cx="36" cy="36" r="' + r + '" stroke="var(--border)" stroke-width="5" fill="none"/>'
    + '<circle cx="36" cy="36" r="' + r + '" stroke="' + color + '" stroke-width="5" fill="none" stroke-dasharray="' + dash + ' ' + circ + '" stroke-linecap="round"/>'
    + '</svg>'
    + '<div class="score-num" style="color:' + color + '">' + score + '</div>'
    + '</div>'
    + '<div class="score-meta">'
    + '<div class="score-verdict">' + esc(s.verdict || '') + '</div>'
    + '<div class="score-detail">' + esc(s.summary || '') + '</div>'
    + '</div>'
    + '</div>'
    + (s.strengths && s.strengths.length ? '<div class="score-gaps"><div class="score-gap-label">Strengths</div>'
      + s.strengths.map(function(g) { return '<div class="score-gap-item"><div class="score-gap-dot green"></div>' + esc(g) + '</div>'; }).join('')
      + '</div>' : '')
    + (s.gaps && s.gaps.length ? '<div class="score-gaps" style="margin-top:8px"><div class="score-gap-label">Gaps to address</div>'
      + s.gaps.map(function(g) { return '<div class="score-gap-item"><div class="score-gap-dot"></div>' + esc(g) + '</div>'; }).join('')
      + '</div>' : '')
    + '</div>';
}

</script>
</body>
</html>
